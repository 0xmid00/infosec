# Nmap Summary (ESP)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

```bash
nmap <scan types> <options> <target>
```

```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```

## Parameters

### IPs to scan

* **`<ip>,<net/mask>`:** Indicate the ips directly
* **`-iL <ips_file>`:** list\_IPs
* **`-iR <number>`**: Number of random Ips, you can exclude possible Ips with `--exclude <Ips>` or `--excludefile <file>`.

### Equipment discovery

By default Nmap launches a discovery phase consisting of: `-PA80 -PS443 -PE -PP`

* **`-sL`**: It is not invasive, it lists the targets making **DNS** requests to resolve names. It is useful to know if for example www.prueba.es/24 all Ips are our targets.
* **`-Pn`**: **No ping**. This is useful if you know that all of them are active (if not, you could lose a lot of time, but this option also produces false negatives saying that they are not active), it prevents the discovery phase.
* **`-sn`** : **No port scan**. After completing the reconnaissance phase, it does not scan ports. It is relatively stealthy, and allows a small network scan. With privileges it sends an ACK (-PA) to 80, a SYN(-PS) to 443 and an echo request and a Timestamp request, without privileges it always completes connections. If the target is the network, it only uses ARP(-PR). If used with another option, only the packets of the other option are dropped.
* **`-PR`**: **Ping ARP**. It is used by default when analyzing computers in our network, it is faster than using pings. If you do not want to use ARP packets use `--disable-arp-ping` or `--send-ip`.
* **`-PS <ports>`**: It sends SYN packets to which if it answers SYN/ACK it is open (to which it answers with RST so as not to end the connection), if it answers RST it is closed and if it does not answer it is unreachable. In case of not having privileges, a total connection is automatically used. If no ports are given, it throws it to 80.
* **`-PA <ports>`**: Like the previous one but with ACK, combining both of them gives better results.
* **`-PU <ports>`**: The objective is the opposite, they are sent to ports that are expected to be closed. Some firewalls only check TCP connections. If it is closed it is answered with port unreachable, if it is answered with another icmp or not answered it is left as destination unreachable.
* **`-PE, -PP, -PM`** : ICMP PINGS: echo replay, timestamp and addresmask. They are launched to find out if the target is active.
* **`-PY<ports>`**: Sends SCTP INIT probes to 80 by default, INIT-ACK(open) or ABORT(closed) or nothing or ICMP unreachable(inactive) can be replied.
* **`-PO <protocols>`**: A protocol is indicated in the headers, by default 1(ICMP), 2(IGMP) and 4(Encap IP). For ICMP, IGMP, TCP (6) and UDP (17) protocols the protocol headers are sent, for the rest only the IP header is sent. The purpose of this is that due to the malformation of the headers, Protocol unreachable or responses of the same protocol are answered to know if it is up.
* **`-n`**: No DNS
* **`-R`**: DNS always
* ** --dns-servers**: 8.8.8.8 192.168.1.1

### Port scanning techniques
| State           | Description |
|----------------|------------|
| **open**       | This indicates that the connection to the scanned port has been established. These connections can be TCP connections, UDP datagrams, as well as SCTP associations. |
| **closed**     | When the port is shown as closed, the TCP protocol indicates that the packet we received back contains an RST flag. This scanning method can also be used to determine if our target is alive or not. |
| **filtered**   | Nmap cannot correctly identify whether the scanned port is open or closed because either no response is returned from the target for the port or we get an error code from the target. |
| **unfiltered** | This state of a port only occurs during the TCP-ACK scan and means that the port is accessible, but it cannot be determined whether it is open or closed. |
| **open\|filtered** | If we do not get a response for a specific port, Nmap will set it to that state. This indicates that a firewall or packet filter may protect the port. |
| **closed\|filtered** | This state only occurs in the IP ID idle scans and indicates that it was impossible to determine if the scanned port is closed or filtered by a firewall. |

* **`-sS`**: Does not complete the connection so it leaves no trace, very good if it can be used.(privileges) It is the one used by default.
* **`-sT`**: Completes the connection, so it does leave a trace, but it can be used for sure. By default without privileges.
* **`-sU`**: Slower, for UDP. Mostly: DNS(53), SNMP(161,162), DHCP(67 and 68), (-sU53,161,162,67,68): open(reply), closed(port unreachable), filtered (another ICMP), open/filtered (nothing). In case of open/filtered, -sV sends numerous requests to detect any of the versions that nmap supports and can detect the true state. It increases a lot the time.
* **`-sY`**: SCTP protocol fails to establish the connection, so there are no logs, works like -PY
* **`-sN,-sX,-sF`:** Null, Fin, Xmas, they can penetrate some firewalls and extract information. They are based on the fact that standard compliant machines should respond with RST all requests that do not have SYN, RST or ACK lags raised: open/filtered(nothing), closed(RST), filtered (ICMP unreachable). Unreliable on WIndows, CIsco, BSDI and OS/400. On unix yes.
* **`-sM`**: Maimon scan: Sends FIN and ACK flags, used for BSD, currently will return all as closed.
* **`-sA, sW`**: ACK and Window, is used to detect firewalls, to know if the ports are filtered or not. The -sW does distinguish between open/closed since the open ones respond with a different window value: open (RST with window other than 0), closed (RST window = 0), filtered (ICMP unreachable or nothing). Not all computers work this way, so if it is all closed, it is not working, if it is a few open, it is working fine, and if it is many open and few closed, it is working the other way around.
* **`-sI`:** Idle scan. For the cases in which there is an active firewall but we know that it does not filter to a certain Ip (or when we simply want anonymity) we can use the zombie scanner (it works for all the ports), to look for possible zombies we can use the scrpit ipidseq or the exploit auxiliary/scanner/ip/ipidseq. This scanner is based on the IPID number of the IP packets.
* **`--badsum`:** It sends the sum wrong, the computers would discard the packets, but the firewalls could answer something, it is used to detect firewalls.
* **`-sZ`:** "Weird" SCTP scanner, when sending probes with cookie echo fragments they should be dropped if open or responded with ABORT if closed. It can pass through firewalls that init does not pass through, the bad thing is that it does not distinguish between filtered and open.
* **`-sO`:** Protocol Ip scan. Sends bad and empty headers in which sometimes not even the protocol can be distinguished. If ICMP unreachable protocol arrives it is closed, if unreachable port arrives it is open, if another error arrives, filtered, if nothing arrives, open|filtered.
* **`-b <server>`:** FTPhost--> It is used to scan a host from another one, this is done by connecting the ftp of another machine and asking it to send files to the ports that you want to scan from another machine, according to the answers we will know if they are open or not. \[\<user>:\<password>@]\<server>\[:\<port>] Almost all ftps servers no longer let you do this and therefore it is of little practical use. 

### **Focus Analysis**

**-p:** Specifies the ports to scan. To select all 65,535 ports, use **-p-** or **-p all**. Nmap categorizes ports by popularity. By default, it scans the top 1,000. With **-F** (fast scan), it scans the top 100. With `--top-ports <number>` , it scans the specified number of top ports (from 1 to 65,535). Nmap checks ports in random order, but **-r** forces sequential order. You can also specify ports explicitly: -p 20-30,80,443,1024-. by range (`-p 22-445`), This last example means scanning from port 1024 onwards. Ports can be grouped by protocol: U:53,T:21-25,80,139,S:9. Nmap can also scan a range of its predefined popular ports: **-p [-1024]** scans up to 1024 based on nmap-services. Use **--port-ratio <ratio>** to scan ports with a commonality ratio between 0 and 1.

**-sV:** Version detection scan. The intensity can be adjusted from 0 to 9 (default is 7).
 **`-v` / `-vv`** verbosity level  which will show us the open ports directly when `Nmap` detects them
**--version-intensity <number>:** Adjusts intensity, with lower values targeting only the most likely probes, reducing scan time significantly for UDP scans.

**-O:** OS detection.

**--osscan-limit:** Requires at least one open and one closed port on a host to attempt OS detection; otherwise, it skips OS prediction to save time.

**--osscan-guess:** Enhances efforts to detect the OS when the detection is not precise.

---

### **Scripts**
script directory :` /usr/share/nmap/scripts  `

**`--script <filename>|<category>|<directory>|<expression>[,...]`**  
To use default scripts: **-sC** or **--script=default**

Script categories include:  

- **Auth:** Executes scripts for authentication.  
- **Broadcast:** Scripts used for host discovery via broadcasting, automatically adding discovered hosts to scans.  
- **Brute:** Attempts login brute-force attacks with credentials.  
- **Default:** Runs the tool's default scripts using the `-sC` option.  
- **Discovery:** Retrieves information about the target and evaluates accessible services.  
- **Dos:** Checks for denial-of-service vulnerabilities but can impact services.  
- **Exploit:** Attempts to exploit known vulnerabilities for the scanned port.  
- **External:** Uses external resources for further processing.  
- **Fuzzer:** Sends various unexpected inputs to identify vulnerabilities, which can be time-consuming.  
- **Intrusive:** Executes potentially intrusive scripts that might negatively affect the target system.  
- **Malware:** Checks for malicious code or backdoors on the target system.  
- **Safe:** Runs non-intrusive, defensive scripts.  
- **Version:** Extends service detection capabilities.  
- **Vuln:** Detects common vulnerabilities.  
- **All:** Runs all available NSE scripts.  
- 
**Examples:**

- **nmap --script-help="http-*** ‚Üí Lists all scripts starting with "http-".
- **nmap --script-help="not intrusive"** ‚Üí Excludes intrusive scripts.
- **nmap --script-help="default or safe"** ‚Üí Includes scripts from either or both categories.

**Arguments:**

- **--script-args <n1>=<v1>,<n2>={<n3>=<v3>},<n4>={<v4>,<v5>}**
- **--script-args-file <filename>**
- **--script-help <expression>|all,...**
- **--script-trace:** Shows script execution progress.
- **--script-updatedb:** Updates the script database.

**To run a script:**  
```bash
nmap --script <script_name> <target>
nmap <target> --script <category>  # Specific Scripts Category
nmap <target>  -sC #  run default scripts

nmap --script "http-*" -p 80,443 {IP}  # HTTP/HTTPS  
nmap --script "ssl-*" -p 443 {IP}  # SSL/TLS  
nmap --script "ftp-*" -p 21 {IP}  # FTP  
nmap --script "ssh-*" -p 22 {IP}  # SSH  
nmap --script "smb-*" -p 139,445 {IP}  # SMB  
nmap --script "smtp-*" -p 25,465,587 {IP}  # SMTP  
nmap --script "dns-*" -p 53 {IP}  # DNS  
nmap --script "snmp-*" -p 161 {IP}  # SNMP  
nmap --script "nfs-*" -p 2049 {IP}  # NFS  
nmap --script "mysql-*" -p 3306 {IP}  # MySQL  
nmap --script "pgsql-*" -p 5432 {IP}  # PostgreSQL  
nmap --script "ms-sql-*" -p 1433 {IP}  # MSSQL  
nmap --script "rdp-*" -p 3389 {IP}  # RDP  
nmap --script "vnc-*" -p 5900-5903 {IP}  # VNC  
nmap --script "telnet-*" -p 23 {IP}  # Telnet  
nmap --script "ldap-*" -p 389 {IP}  # LDAP  
nmap --script "rpc-*" -p 111 {IP}  # RPC  
nmap --script "redis-*" -p 6379 {IP}  # Redis  
nmap --script "vuln" -p- {IP}  # Vulnerability Scan  
nmap --script "default or Discovery or  or exploit or vuln" -p- {IP}  # All Scripts  

```
More information about NSE scripts and the corresponding categories we can find at: [https://nmap.org/nsedoc/index.html](https://nmap.org/nsedoc/index.html)

---

### **Time Control**

**Nmap timing options:**  
**--host-timeout <time>**: Sets timeout (e.g., 900000ms, 900s, 15m).  
**--min-hostgroup <numhosts>; --max-hostgroup <numhosts>**: Adjusts parallel scan group sizes.  
**--min-parallelism <numprobes>; --max-parallelism <numprobes>**: Controls the number of parallel probes (automatic by default).  
**--min-rtt-timeout <time>; --max-rtt-timeout <time>; --initial-rtt-timeout <time>**: Adjusts RTT timeout.  
**--max-retries <numtries>**: Limits retry attempts.  
**--host-timeout <time>**: Adjusts host scan timeout.  
**--scan-delay <time>; --max-scan-delay <time>**: Sets delay between probes.  
**--min-rate <number>; --max-rate <number>**: Adjusts packets sent per second.

To speed up scanning for open ports only: **--defeat-rst-ratelimit**

**Aggressiveness levels (-T):**

- **-T0:** One port at a time, 5-minute delay.
- **-T1/T2:** Slower with 15s and 0.4s delays.
- **-T3:** Default behavior with parallelism.
- **-T4:** Faster with adjusted timeouts.
- **-T5:** Most aggressive settings.

---

### **Firewall/IDS Evasion**

  **detect  FIrewall**: `-sA`  TCP ACK scan method is much harder to filter for firewalls and IDS/IPS
 **Detecting IDS**: Aggressively scan a single port/service and observe if security measures are triggered.
**Detecting IPS:** Use a VPS to scan; if it gets blocked, an IPS is likely in place.

- **-f:** Fragment packets into 8-byte chunks.
- **-D decoy1,decoy2,ME:** Uses decoy IPs to mask the scanner's IP.
- **-S <IP>:** Spoofs source IP.
- **-e <interface>:** Selects a specific interface.
- **--source-port <portnumber> or -g <portnumber>:** Sends packets from a specific source port.
 ***examples***:
```bash
#Decoys: Decoys help evade IDS/IPS by inserting fake IPs into scan traffic, making it harder to detect the attacker's real IP. (do not work with version detection or TCP connect scan) )
sudo nmap 10.129.2.28 -p 80 -sS -Pn -n --disable-arp-ping -D RND:5  # Uses 5 random decoys. 
sudo nmap 10.129.2.28 -n -Pn -p 445 -O -S 10.129.2.200 -e tun0 # Uses a specific spoofed source IP (work when only individual subnets would not have access to the server's specific services)

# DNS Proxying : use TCP port 53 as a source port to bypass firewalls and IDS/IPS filters.(doesn't work for OS detection)
sudo nmap <ip> -p <port> -sU -Pn -n --disable-arp-ping --packet-trace --source-port 53 # UDP  for normal queries
sudo nmap <ip> -p 445 -sS -Pn -n --disable-arp-ping --packet-trace --source-port 53 # TCP for larger responses, such as zone transfers
nc -p 53 10.129.232.225 50000 # connect using specific source port 




```

---

### **Outputs**

- **-oN file:** Normal output.
- **-oX file:** XML output (`xsltproc target.xml -o target.htm` creat html readable file).
- **-oS file:** Script kiddie-style output.
- **-oG file:** Grepable output.
- **-oA file:** Generates all outputs except -oS.

**Additional options:**

- **-v <level>:** Sets verbosity.
- **-d <level>:** Enables debugging.
- **--reason:** Explains host and port state reasons.
- **--stats-every <time>:** Displays progress updates at intervals.
-  **--packet-trace:** Shows all packets sent and received
---


1. Scipvuldb.csv | [http://www.scip.ch/en/?vuldb](http://www.scip.ch/en/?vuldb)
2. Cve.csv | [http://cve.mitre.org](http://cve.mitre.org/)
3. Osvdb.csv | [http://www.osvdb.org](http://www.osvdb.org/)
4. Securityfocus.csv | [http://www.securityfocus.com/bid/](http://www.securityfocus.com/bid/)
5. Securitytracker.csv | [http://www.securitytracker.com](http://www.securitytracker.com/)
6. Xforce.csv | [http://xforce.iss.net](http://xforce.iss.net/)
7. Exploitdb.csv | [http://www.exploit-db.com](http://www.exploit-db.com/)
8. Openvas.csv | [http://www.openvas.org](http://www.openvas.org/)

**To download and install it in the Nmap folder:**

wget [http://www.computec.ch/projekte/vulscan/download/nmap_nse_vulscan-2.0.tar.gz](http://www.computec.ch/projekte/vulscan/download/nmap_nse_vulscan-2.0.tar.gz) && tar -czvf nmap_nse_vulscan-2.0.tar.gz vulscan/ && sudo cp -r vulscan/ /usr/share/nmap/scripts/

You also need to download the database packages and add them to /usr/share/nmap/scripts/vulscan/.

Usage:

To use all databases:  
sudo nmap -sV --script=vulscan TARGET_HOST

To use a specific database:  
sudo nmap -sV --script=vulscan --script-args vulscandb=cve.csv TARGET_HOST

## Speed Up Nmap Service scan x16

According [**to this post**](https://joshua.hu/nmap-speedup-service-scanning-16x) you can speed up the nmap service analysis by modifying all the **`totalwaitms`** values in  **`/usr/share/nmap/nmap-service-probes`** to **300** and **`tcpwrappedms`** to **200**.

Moreover, probes which do not have a specifically defined **`servicewaitms`** use a default value of **`5000`**. Therefore, we can either add values to each of the probes, or we can **compile nmap** ourselves and change the default value in [**service\_scan.h**](https://github.com/nmap/nmap/blob/master/service\_scan.h#L79).

If you don't want to change the values of **`totalwaitms`** and **`tcpwrappedms`** at all in the `/usr/share/nmap/nmap-service-probes` file, you can edit the [parsing code](https://github.com/nmap/nmap/blob/master/service\_scan.cc#L1358) such that these values in the `nmap-service-probes` file are completely ignored.

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
