# NTLM Authentication

 Active Directory uses several other authentication methods : LM and NT(NTLM) hashes and NTLMv1 and NTLMv2 protocols .
#### Hash Protocol Comparison

| **Hash/Protocol** | **Cryptographic technique**                          | **Mutual Authentication** | **Message Type**                | **Trusted Third Party**                         |
| ----------------- | ---------------------------------------------------- | ------------------------- | ------------------------------- | ----------------------------------------------- |
| `NTLM (v1 & v2)`  | Symmetric key cryptography                           | No                        | Random number                   | Domain Controller                               |
| `NTLMv1`          | Symmetric key cryptography                           | No                        | MD4 hash, random number         | Domain Controller                               |
| `NTLMv2`          | Symmetric key cryptography                           | No                        | MD4 hash, random number         | Domain Controller                               |
| `Kerberos`        | Symmetric key cryptography & asymmetric cryptography | Yes                       | Encrypted ticket using DES, MD5 | Domain Controller/Key Distribution Center (KDC) |
## Hashes
### LM 
`LAN Manager` oldest password storage mechanism used by the Windows before to Windows Vista and Windows Server 2008 , he stored in the SAM database on a Windows host and the NTDS.DIT database on a Domain Controller in ==16 bytes== lengh.
LM hashing is disabled by default since Windows Vista/Server 2008, but it may still be found in older systems. LM passwords are limited to 14 characters, not case-sensitive, and are converted to uppercase before hashing. The password is split into two 7-character parts, each used to create a DES key. These keys encrypt the fixed string "KGS!@#$%", producing two ciphertexts that form the LM hash. This method makes LM hashes easy to crack, as attackers only need to brute-force 7 characters at a time. If the password is 7 characters or less, the second half of the hash is always the same. LM hashes can be disabled through Group Policy.
>Windows operating systems prior to Windows Vista and Windows Server 2008 (Windows NT4, Windows 2000, Windows 2003, Windows XP) stored both the LM hash and the NTLM hash of a user's password by default.
### NTHash (NTLM)
`NT LAN Manager` (NTLM) hashes used on modern Windows systems, It is a challenge-response authentication protocol. it uses three messages to authenticate: a client first sends a `NEGOTIATE_MESSAGE` to the server, whose response is a `CHALLENGE_MESSAGE` to verify the client's identity. Lastly, the client responds with an `AUTHENTICATE_MESSAGE`.
![[Pasted image 20250704112032.png]]

NTLM supports two hash types: **LM** (older, weaker) and **NT hash** ==16 bytes== length  , which is generated by applying **MD4** to the **UTF-16 little-endian** version of the password. Although NT hashes are stronger than LM and support Unicode, they can still be **brute-forced offline** with tools like **Hashcat** — even 8-character NT hashes can be cracked in under 3 hours with a GPU.
NTLM hashes are stored in the format:  `username:RID:LM_hash:NTLM_hash:::`

NTLM is vulnerable to **pass-the-hash attacks**, where an attacker can use a stolen NT hash to authenticate without knowing the actual password. example:
```bash
crackmapexec smb 10.129.41.19 -u rachel -H e46b9e548fa0d122de7f59fb6d48eaa2
```

## protocols
### NTLMv1 (Net-NTLMv1)
NTLM is a challenge-response protocol that uses the **NT hash**. NTLMv1 also uses the **LM hash**, making it easier to **crack offline** after capturing hashes (e.g., via Responder or NTLM relay). It’s used for **network authentication**. 

 **V1 Challenge & Response Algorithm:**
```bash
C = 8-byte server challenge, random
K1 | K2 | K3 = LM/NT-hash | 5-bytes-0
response = DES(K1,C) | DES(K2,C) | DES(K3,C)
```
The server sends an **8-byte challenge**, and the client responds with a **24-byte value** based on the hash. The resulting **Net-NTLMv1 hash** can be cracked but **cannot be used for pass-the-hash attacks** coz it **challenge-response hashe** captured ==Not the actuality NT Hash== during network authentication and you must **crack** them first to get the **NT hash**.

An example of a full NTLMv1 hash (**NTLMv1 captured hash**) looks like:
```bash
u4-netntlm::kNS:338d08f8e26de93300000000000000000000000000000000:9526fb8c23a90751cdd619b6cea564742e1e4bf33006ba41:cb8086049ec4736c
# formate
username::domain:server_challenge:ntlm_response[:client_challenge]
```

**NTLMv1** is vulnerable to **relay attack**, also we can cracking  captured **challenge-response hashe** 

### NTLMv2 (Net-NTLMv2)
NTLMv2 was introduced in **Windows NT 4.0 SP4** as a stronger replacement for NTLMv1 and became the default in **Windows Server 2000**. It improves security by using **HMAC-MD5** and adding protection against **spoofing and replay attacks**.

It works by sending two responses to the server's **8-byte challenge**:

- One includes a 16-byte HMAC-MD5 hash, a **random client challenge**, and a hash of the user's credentials.
    
- The second includes a **timestamp**, another random value, and the **domain name**, making the protocol more resistant to attacks.
 **V2 Challenge & Response Algorithm:**
 ```bash
SC = 8-byte server challenge, random
CC = 8-byte client challenge, random
CC* = (X, time, CC2, domain name)
v2-Hash = HMAC-MD5(NT-Hash, user name, domain name)
LMv2 = HMAC-MD5(v2-Hash, SC, CC)
NTv2 = HMAC-MD5(v2-Hash, SC, CC*)
response = LMv2 | CC | NTv2 | CC*
```
 **NTLMv1 Hash Example:**
 ```bash
netntlm::kNS:338d08f8e26de93300000000000000000000000000000000:9526fb8c23a90751cdd619b6cea564742e1e4bf33006ba41:cb8086049ec4736c

USERNAME::DOMAIN:LMv2_Response:NTv2_Response
```
**NTLMv2** is vulnerable to **relay attack** , also we can crack captured **challenge-response hashe** 
### Domain Cached Credentials (MSCache2)
In Active Directory environments, **Domain Cached Credentials (DCC)**—specifically **MSCache v2**—allow users to log into a domain-joined machine even when the Domain Controller is unreachable (e.g., due to network issues). The system stores the last **10 login password hashes** for domain users in the Windows Registry at:
`HKEY_LOCAL_MACHINE\SECURITY\Cache`
These cached hashes are:

- **Not usable** in Pass-the-Hash attacks.
    
- **Very slow to crack**, even with high-performance GPU tools like Hashcat.
    
- Typically require **weak passwords** or highly **targeted cracking** to succeed.
    
- Stored in the format:  
    `$DCC2$<iteration>#<username>#<hash>`
    

Attackers can extract these hashes after obtaining **local administrator access**. As penetration testers, it is crucial to recognize such hashes, understand their limitations, and evaluate whether cracking them is worthwhile based on the context.